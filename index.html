<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GHUMO PRO - Exit Option</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        :root { --glass: rgba(255, 255, 255, 0.95); --text: #333; }
        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(135deg, #833ab4, #fd1d1d, #fcb045);
            background-attachment: fixed;
            min-height: 100vh; color: var(--text); padding-bottom: 30px; user-select: none;
        }

        /* CARD STYLE */
        .vibrant-card {
            background: var(--glass); backdrop-filter: blur(10px); border-radius: 20px;
            padding: 15px; margin-bottom: 15px; box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        /* HEADER */
        .app-header {
            background: rgba(255,255,255,0.25); backdrop-filter: blur(12px); padding: 15px 20px;
            position: sticky; top: 0; z-index: 1000; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.3); color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        /* BUTTONS */
        .btn-grad { border: none; border-radius: 50px; padding: 10px; font-weight: 700; color: white; width: 100%; transition: 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .btn-grad:active { transform: scale(0.96); }
        
        .bg-orange { background: linear-gradient(to right, #FF512F, #DD2476); }
        .bg-green { background: linear-gradient(to right, #11998e, #38ef7d); }
        .bg-blue { background: linear-gradient(to right, #2193b0, #6dd5ed); }
        .bg-dark { background: linear-gradient(to right, #232526, #414345); }
        .bg-purple { background: linear-gradient(to right, #8E2DE2, #4A00E0); }
        .bg-red { background: linear-gradient(to right, #cb2d3e, #ef473a); } /* Exit Button */

        /* INPUTS */
        .vib-input { border: 1px solid #ddd; background: #fff; padding: 10px; border-radius: 12px; width: 100%; margin-bottom: 8px; outline: none; }
        
        /* LISTS */
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; position: relative; }
        .head-badge { background: gold; color: black; padding: 3px 8px; border-radius: 10px; font-weight: bold; border: 1px solid orange; box-shadow: 0 0 10px gold; }
        
        /* MODALS */
        .custom-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-box { background: white; padding: 25px; border-radius: 25px; width: 90%; max-width: 350px; text-align: center; position: relative; }
        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #aaa; }

        /* UTILS */
        .hidden { display: none !important; }
        .full-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #833ab4, #fd1d1d, #fcb045); }
        .feed-img { width: 100%; height: 250px; object-fit: cover; border-radius: 10px; margin-top: 5px; }
        .action-icon { cursor: pointer; margin-left: 10px; font-size: 1.1rem; }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>

<div id="estModal" class="custom-modal"><div class="modal-box"><span class="close-btn" onclick="closeModal('estModal')">√ó</span><h4 class="text-primary fw-bold">üìä Estimate Trip</h4><div class="text-start small fw-bold text-muted">Fuel</div><div class="d-flex gap-2"><input type="number" id="eDist" class="vib-input" placeholder="KM"><input type="number" id="eMil" class="vib-input" placeholder="Avg"></div><input type="number" id="eRate" class="vib-input" placeholder="Price"><div class="text-start small fw-bold text-muted mt-2">Other</div><input type="number" id="eHotel" class="vib-input" placeholder="Hotel Cost"><input type="number" id="eOther" class="vib-input" placeholder="Food/Misc"><input type="number" id="ePpl" class="vib-input" placeholder="No. of People"><button class="btn-grad bg-blue mt-2" onclick="calcEst()">Calculate</button><div id="estRes" class="mt-3 p-2 bg-light rounded hidden"><h3 class="text-primary fw-bold">Total: ‚Çπ<span id="rTot">0</span></h3><h5 class="text-success">Per Head: ‚Çπ<span id="rHead">0</span></h5></div></div></div>

<div id="headSetupModal" class="custom-modal"><div class="modal-box"><span class="close-btn" onclick="closeModal('headSetupModal')">√ó</span><h5>üè¶ Head UPI Setup</h5><input type="text" id="headUPIInput" class="vib-input mt-3" placeholder="Enter UPI ID"><button class="btn-grad bg-blue" onclick="saveHeadUPI()">Save</button></div></div>

<div id="payHeadModal" class="custom-modal"><div class="modal-box"><span class="close-btn" onclick="closeModal('payHeadModal')">√ó</span><h5 class="text-primary">Pay to Head</h5><p id="hName" class="small text-muted">--</p><div id="hQr" class="my-2"></div><h3 class="mt-2">‚Çπ<span id="hAmt">0</span></h3><a id="hLink" class="btn-grad bg-green mb-2" href="#">Pay Now</a><button class="btn-grad bg-dark" onclick="confPay()">‚úÖ I Paid</button></div></div>

<div id="qrModal" class="custom-modal"><div class="modal-box"><span class="close-btn" onclick="closeModal('qrModal')">√ó</span><h5 class="text-success">Support Dev</h5><div id="dQr" class="my-2"></div><h3 class="mt-2">‚Çπ<span id="dAmt">0</span></h3><a id="dLink" class="btn-grad bg-dark" href="#">Pay via UPI</a></div></div>

<div id="aboutModal" class="custom-modal"><div class="modal-box"><span class="close-btn" onclick="closeModal('aboutModal')">√ó</span><h4>GHUMO PRO</h4><p class="small text-muted">Version 5.0 (Exit Feature)</p><hr><p class="small"><b>Dev:</b> <span id="devNameAbout">--</span></p></div></div>

<div id="authScreen" class="full-screen">
    <div class="vibrant-card text-center" style="width:320px; background:white;">
        <h1 class="fw-bold mb-4" style="color:#fd1d1d;">GHUMO</h1>
        <div id="loginForm">
            <input type="number" id="l_mobile" class="vib-input" placeholder="Mobile">
            <input type="password" id="l_pass" class="vib-input" placeholder="Password">
            <button class="btn-grad bg-orange mb-3" onclick="doLogin()">LOGIN</button>
            <button class="btn btn-link text-muted" onclick="showReg()">Create Account</button>
        </div>
        <div id="regForm" class="hidden">
            <input type="text" id="r_name" class="vib-input" placeholder="Name">
            <input type="number" id="r_mobile" class="vib-input" placeholder="Mobile">
            <input type="text" id="r_address" class="vib-input" placeholder="Address">
            <input type="password" id="r_pass" class="vib-input" placeholder="Password">
            <button class="btn-grad bg-green mb-3" onclick="doRegister()">REGISTER</button>
            <button class="btn btn-link text-muted" onclick="showLogin()">Back</button>
        </div>
    </div>
</div>

<div id="homeScreen" class="hidden">
    <div class="app-header">
        <div class="fw-bold">GHUMO <small>| <span id="uName">User</span></small></div>
        <i class="bi bi-gear-fill fs-4" style="cursor:pointer;" onclick="openSettings()"></i>
    </div>
    <div class="container py-3">
        <div class="row g-3 mb-3">
            <div class="col-6"><button class="btn-grad bg-blue" onclick="createTrip()"><i class="bi bi-plus-circle"></i> Create</button></div>
            <div class="col-6"><button class="btn-grad bg-dark" onclick="joinTrip()"><i class="bi bi-rocket-takeoff"></i> Join</button></div>
        </div>
        
        <div class="vibrant-card p-2">
            <h6 class="fw-bold ps-2 mb-2">üî• DEALS</h6>
            <div class="d-flex gap-2 overflow-auto">
                <button class="btn btn-light btn-sm border rounded-pill" onclick="window.open('https://booking.com')">üè® Hotels</button>
                <button class="btn btn-light btn-sm border rounded-pill" onclick="window.open('https://makemytrip.com')">‚úàÔ∏è Flights</button>
                <button class="btn btn-light btn-sm border rounded-pill" onclick="window.open('https://amazon.in')">üéí Gear</button>
            </div>
        </div>

        <h6 class="text-white fw-bold ps-2">MY TRIPS</h6>
        <div id="userTripList"><p class="text-center text-white small">Loading...</p></div>
        
        <br><button class="btn-grad bg-white text-danger mb-4" onclick="donate()">‚ù§Ô∏è Support Dev</button>
        <div id="globalFeed"></div>
    </div>
</div>

<div id="mainApp" class="hidden">
    <div class="app-header">
        <i class="bi bi-arrow-left fs-3" style="cursor:pointer;" onclick="showHome()"></i>
        <div class="text-center"><span class="fw-bold" id="tName">Trip</span><br><small id="tCode" style="opacity:0.8"></small></div>
        <div></div>
    </div>

    <div class="container py-3">
        <div class="vibrant-card text-center py-2">
            <div class="row">
                <div class="col-6 border-end"><small>BALANCE</small><br><h3 class="fw-bold text-primary">‚Çπ<span id="bal">0</span></h3></div>
                <div class="col-6"><small>PER HEAD</small><br><h3 class="fw-bold text-success">‚Çπ<span id="ph">0</span></h3></div>
            </div>
        </div>

        <div id="headArea" class="mb-3"></div>

        <div class="row g-2 mb-3">
            <div class="col-6"><button class="btn-grad bg-orange small" onclick="toggle('formExp')">üí∏ Expense</button></div>
            <div class="col-6"><button class="btn-grad bg-green small" onclick="toggle('formDep')">üí∞ Deposit</button></div>
            <div class="col-6"><button class="btn-grad bg-blue small" onclick="document.getElementById('estModal').style.display='flex'">üìä Estimate</button></div>
            <div class="col-6"><button class="btn-grad bg-dark small" onclick="toggle('formMem')">üì∏ Post</button></div>
        </div>

        <div id="formExp" class="vibrant-card hidden">
            <h6 class="text-danger fw-bold">Add Expense</h6>
            <input type="text" id="exR" class="vib-input" placeholder="Item Name">
            <input type="number" id="exA" class="vib-input" placeholder="Amount ‚Çπ">
            <button class="btn-grad bg-orange" onclick="addExp()">Add</button>
        </div>
        <div id="formDep" class="vibrant-card hidden">
            <h6 class="text-success fw-bold">Deposit</h6>
            <select id="dpM" class="vib-input"></select>
            <input type="number" id="dpA" class="vib-input" placeholder="Amount ‚Çπ">
            <button class="btn-grad bg-green" onclick="addDep()">Deposit</button>
        </div>
        <div id="formMem" class="vibrant-card hidden">
            <h6 class="text-dark fw-bold">Create Post</h6>
            <input type="text" id="mTxt" class="vib-input" placeholder="Caption...">
            <input type="text" id="mLoc" class="vib-input" placeholder="üìç Location (City/Place)">
            <input type="file" id="mImg" class="vib-input" multiple onchange="encImg(this)">
            <div class="d-flex gap-2 mt-2">
                <button class="btn-grad bg-dark" onclick="saveMem('trip')">To Trip</button>
                <button class="btn-grad bg-purple" onclick="saveMem('world')">To World</button>
            </div>
        </div>

        <div class="vibrant-card border-info" style="border-left:5px solid #0dcaf0;">
            <h6 class="text-info fw-bold">üöå Transport & Route</h6>
            <div class="d-flex gap-2">
                <select id="trMode" class="vib-input w-50"><option>Bus</option><option>Train</option><option>Flight</option><option>Taxi</option></select>
                <input type="number" id="trFare" class="vib-input w-50" placeholder="Fare ‚Çπ">
            </div>
            <div class="d-flex gap-2">
                <input type="text" id="trFrom" class="vib-input" placeholder="From">
                <input type="text" id="trTo" class="vib-input" placeholder="To">
            </div>
            <button class="btn-grad bg-blue mb-2" onclick="addTrans()">Add Route</button>
            <button class="btn-grad bg-green" onclick="shareRoute()">üì≤ Share Itinerary</button>
        </div>

        <div class="vibrant-card">
            <h6 class="text-muted small fw-bold mb-2">RECENT ACTIVITY</h6>
            <div id="actList" style="max-height:250px; overflow-y:auto;"></div>
        </div>

        <div class="vibrant-card">
            <h6 class="fw-bold">Members <small class="text-muted fw-normal">(Tap name to make Head)</small></h6>
            <div id="memList" class="d-flex flex-wrap gap-2"></div>
        </div>

        <button class="btn-grad bg-red mt-3 mb-4" onclick="exitTrip()"><i class="bi bi-box-arrow-left"></i> Exit Trip</button>

        <h6 class="text-white fw-bold mt-4 ps-2">MEMORIES</h6>
        <div id="feedArea"></div>
        <div class="vibrant-card mt-3"><h6 class="text-primary">Settlement</h6><div id="finalList" class="small"></div></div>
    </div>
</div>

<div id="settingsScreen" class="hidden full-screen" style="background:white; z-index:3000; overflow-y:auto; display:block;">
    <div class="app-header"><i class="bi bi-arrow-left fs-3" style="cursor:pointer;" onclick="showHome()"></i> Settings <div></div></div>
    <div class="container text-center py-5">
        <div class="vibrant-card">
            <h4 id="setName">--</h4>
            <input type="text" id="upN" class="vib-input" placeholder="Name">
            <input type="text" id="upP" class="vib-input" placeholder="Password">
            <button class="btn-grad bg-blue mb-3" onclick="updProf()">Update Profile</button>
        </div>
        <button class="btn-grad bg-white text-dark mb-3 shadow-sm border" onclick="document.getElementById('aboutModal').style.display='flex'">‚ÑπÔ∏è About App</button>
        <button class="btn-grad bg-orange" onclick="doLogout()">Log Out</button>
    </div>
</div>

<script>
// CONFIG
const DEV_NAME="YOUR NAME", UPI_ID="YOUR_UPI";
const firebaseConfig = { apiKey: "AIzaSyCp_ctBvgHAmqxpU9xDbxaufDftKulcJXk", authDomain: "akproject-176c7.firebaseapp.com", databaseURL: "https://akproject-176c7-default-rtdb.firebaseio.com", projectId: "akproject-176c7", storageBucket: "akproject-176c7.firebasestorage.app", messagingSenderId: "769234833598", appId: "1:769234833598:web:db90a08802c07d94810eef" };
firebase.initializeApp(firebaseConfig); const db=firebase.database();
let user=null, tid="", trip={}, imgs=[], hPay=0;
function safe(d){return d?(Array.isArray(d)?d:Object.values(d)):[];}
function closeModal(id){document.getElementById(id).style.display='none';}
function toggle(id){const e=document.getElementById(id);e.classList.toggle('hidden');}

// AUTH
window.onload=()=>{
    document.querySelectorAll('#devNameAbout').forEach(e=>e.innerText=DEV_NAME);
    const s=localStorage.getItem('yatra_user');
    if(s){ user=JSON.parse(s); document.getElementById('uName').innerText=user.name; showHome(); } 
    else document.getElementById('authScreen').classList.remove('hidden');
};
function hideAll(){ ['authScreen','homeScreen','mainApp','settingsScreen'].forEach(i=>document.getElementById(i).classList.add('hidden')); }
function showHome(){ hideAll(); document.getElementById('homeScreen').classList.remove('hidden'); loadTrips(); loadWorld(); }
function openSettings(){ hideAll(); document.getElementById('settingsScreen').classList.remove('hidden'); document.getElementById('setName').innerText=user.name; document.getElementById('upN').value=user.name; document.getElementById('upP').value=user.password; }

function doLogin(){
    const m=document.getElementById('l_mobile').value,p=document.getElementById('l_pass').value; if(!m||!p)return;
    db.ref('users/'+m).once('value',s=>{
        if(s.exists()&&s.val().password==p){ user=s.val(); localStorage.setItem('yatra_user',JSON.stringify(user)); document.getElementById('uName').innerText=user.name; showHome(); }
        else alert("Invalid Credentials");
    });
}
function doRegister(){
    const n=document.getElementById('r_name').value,m=document.getElementById('r_mobile').value,p=document.getElementById('r_pass').value;
    if(n&&m&&p) db.ref('users/'+m).set({name:n,mobile:m,password:p,history:[]}).then(()=>{alert("Created!");toggle('regForm');toggle('loginForm');});
}
function showReg(){ toggle('loginForm'); toggle('regForm'); }
function doLogout(){ localStorage.removeItem('yatra_user'); location.reload(); }
function updProf(){ const n=document.getElementById('upN').value, p=document.getElementById('upP').value; if(n) db.ref('users/'+user.mobile).update({name:n,password:p}).then(()=>{user.name=n;localStorage.setItem('yatra_user',JSON.stringify(user));alert("Updated!");showHome();}); }

// TRIP LOGIC
function createTrip(){const n=prompt("Name:");if(n){const id="T"+Math.floor(10000+Math.random()*90000);db.ref('trips/'+id).set({name:n,members:[user.name]}).then(()=>{addHist(id);enterTrip(id);});}}
function joinTrip(){const i=prompt("Code:");if(i)db.ref('trips/'+i.toUpperCase()).once('value',s=>{if(s.exists()){addHist(i.toUpperCase());enterTrip(i.toUpperCase());}else alert("Invalid");});}
function addHist(id){db.ref('users/'+user.mobile+'/history').once('value',s=>{let h=safe(s.val());if(!h.includes(id)){h.push(id);db.ref('users/'+user.mobile+'/history').set(h);}});}
function loadTrips(){db.ref('users/'+user.mobile+'/history').on('value',async s=>{const l=document.getElementById('userTripList');l.innerHTML="";const c=safe(s.val());if(!c.length){l.innerHTML="<p class='text-center text-white small'>No trips.</p>";return;}for(const i of c){const sp=await db.ref('trips/'+i).once('value');if(sp.exists())l.innerHTML+=`<div class="vibrant-card d-flex justify-content-between p-2 mb-2" onclick="enterTrip('${i}')"><b>${sp.val().name}</b><small>${i}</small></div>`;}});}

function enterTrip(id){
    tid=id; hideAll(); document.getElementById('mainApp').classList.remove('hidden');
    db.ref('trips/'+tid).on('value',s=>{
        trip=s.val(); if(!trip)return;
        let m=safe(trip.members); if(!m.includes(user.name)){m.push(user.name);db.ref('trips/'+tid+'/members').set(m);}
        renderUI();
    });
}

// NEW: EXIT TRIP FUNCTION
function exitTrip() {
    if(!confirm("‚ö†Ô∏è Are you sure you want to leave this trip?")) return;
    if(trip.head === user.name) {
        alert("‚ùå You are the HEAD! Please assign a new Head before leaving.");
        return;
    }
    
    // 1. Remove from Members List
    const newMembers = safe(trip.members).filter(m => m !== user.name);
    db.ref('trips/'+tid+'/members').set(newMembers);

    // 2. Remove from User History
    db.ref('users/'+user.mobile+'/history').once('value', s => {
        const newHist = safe(s.val()).filter(id => id !== tid);
        db.ref('users/'+user.mobile+'/history').set(newHist);
        alert("You have left the trip.");
        showHome();
    });
}

function renderUI(){
    document.getElementById('tName').innerText=trip.name; document.getElementById('tCode').innerText=tid;
    const isHead=(user.name.toLowerCase()===(trip.head||"").toLowerCase());
    const hDiv=document.getElementById('headArea'); hDiv.innerHTML=isHead?`<button class="btn-grad bg-blue" onclick="document.getElementById('headSetupModal').style.display='flex'">üè¶ Setup UPI</button>`:(trip.head?`<button class="btn-grad bg-green" onclick="payH()">üí∏ Pay Head</button>`:"");

    const l=document.getElementById('actList'); l.innerHTML="";
    // Deposits
    safe(trip.deposits).slice().reverse().forEach(d=>{
        const del=(d.who===user.name||isHead)?`<i class="bi bi-trash text-danger action-icon" onclick="delD(${d.t})"></i>`:"";
        l.innerHTML+=`<div class="list-item" style="border-left:4px solid #2ecc71"><div><small>${d.who}</small><br><b>+‚Çπ${d.amt}</b></div>${del}</div>`;
    });
    // Expenses
    safe(trip.expenses).slice().reverse().forEach(e=>{
        const del=(isHead||e.who===user.name)?`<div class="d-flex"><i class="bi bi-pencil text-primary action-icon" onclick="edE(${e.t},'${e.r}','${e.a}')"></i><i class="bi bi-trash text-danger action-icon" onclick="delE(${e.t})"></i></div>`:"";
        l.innerHTML+=`<div class="list-item" style="border-left:4px solid #e74c3c"><div><small>${e.r}</small><br><b>-‚Çπ${e.a}</b></div>${del}</div>`;
    });

    // Members
    const ml=document.getElementById('memList'); ml.innerHTML=""; const sl=document.getElementById('dpM'); sl.innerHTML="";
    trip.members.forEach(m=>{
        const isH=(trip.head&&m.toLowerCase()===trip.head.toLowerCase());
        ml.innerHTML+=`<span class="badge ${isH?'head-badge':'bg-white text-dark'} p-2 border" onclick="mkHead('${m}')">${isH?'üëë':''} ${m}</span>`;
        sl.innerHTML+=`<option value="${m}">${m}</option>`;
    });

    // Stats
    const tin=safe(trip.deposits).reduce((s,x)=>s+x.amt,0), tout=safe(trip.expenses).reduce((s,x)=>s+x.a,0);
    document.getElementById('bal').innerText=tin-tout; 
    document.getElementById('ph').innerText=trip.members.length?Math.round(tout/trip.members.length):0;
    
    // Settlement
    const fl=document.getElementById('finalList'); fl.innerHTML=""; let avg=Math.round(tout/trip.members.length), pd={};
    trip.members.forEach(m=>pd[m]=0); safe(trip.deposits).forEach(d=>{if(pd[d.who]!==undefined)pd[d.who]+=d.amt;});
    trip.members.forEach(m=>{let b=avg-pd[m]; fl.innerHTML+=`<div class="d-flex justify-content-between border-bottom py-1"><span>${m}</span><span>${b>0?'Pay: '+b:'Get: '+Math.abs(b)}</span></div>`;});

    renderFeed();
}

// ACTIONS
function addExp(){const r=document.getElementById('exR').value,a=parseFloat(document.getElementById('exA').value);if(r&&a){db.ref('trips/'+tid+'/expenses').set([...safe(trip.expenses),{r,a,who:user.name,t:Date.now()}]);toggle('formExp');}}
function addDep(){const w=document.getElementById('dpM').value,a=parseFloat(document.getElementById('dpA').value);if(w&&a){db.ref('trips/'+tid+'/deposits').set([...safe(trip.deposits),{who:w,amt:a,t:Date.now()}]);toggle('formDep');}}
function delE(t){if(confirm("Delete?"))db.ref('trips/'+tid+'/expenses').set(safe(trip.expenses).filter(x=>x.t!==t));}
function delD(t){if(confirm("Delete Deposit?"))db.ref('trips/'+tid+'/deposits').set(safe(trip.deposits).filter(x=>x.t!==t));}
function edE(t,or,oa){const nr=prompt("Item:",or),na=prompt("Amount:",oa);if(nr&&na)db.ref('trips/'+tid+'/expenses').set(safe(trip.expenses).map(x=>x.t===t?{...x,r:nr,a:parseFloat(na)}:x));}

function mkHead(n){if(confirm("Make "+n+" Head?"))db.ref('trips/'+tid+'/head').set(n);}
function saveHeadUPI(){const u=document.getElementById('headUPIInput').value;if(u){db.ref('trips/'+tid+'/headUPI').set(u);closeModal('headSetupModal');}}
function payH(){const a=prompt("Amount:");if(a){if(!trip.headUPI){alert("No UPI");return;}hPay=parseFloat(a);const l=`upi://pay?pa=${trip.headUPI}&pn=${trip.head}&am=${a}&cu=INR`;document.getElementById('payHeadModal').style.display='flex';document.getElementById('hName').innerText="To: "+trip.head;document.getElementById('hAmt').innerText=a;document.getElementById('hLink').href=l;document.getElementById('hQr').innerHTML=`<img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(l)}">`;}}
function confPay(){db.ref('trips/'+tid+'/deposits').set([...safe(trip.deposits),{who:user.name,amt:hPay,t:Date.now()}]);closeModal('payHeadModal');alert("Added!");}

// TRANSPORT
function addTrans(){const m=document.getElementById('trMode').value,f=document.getElementById('trFrom').value,t=document.getElementById('trTo').value,a=parseFloat(document.getElementById('trFare').value);if(f&&t&&a){db.ref('trips/'+tid+'/expenses').set([...safe(trip.expenses),{r:`${m}: ${f} ‚ûî ${t}`,a,who:user.name,t:Date.now()}]);alert("Added!");}}
function shareRoute(){const r=safe(trip.expenses).filter(e=>e.r.includes("‚ûî"));if(!r.length)return alert("No routes");let m=`üöÄ *TRIP PLAN: ${trip.name}*\n\n`,t=0;r.forEach((x,i)=>{m+=`‚úÖ ${x.r} (‚Çπ${x.a})\n`;t+=x.a;});m+=`\nüí∞ Total: ‚Çπ${t}`;window.open(`https://wa.me/?text=${encodeURIComponent(m)}`,'_blank');}

// ESTIMATE
function calcEst(){
    const d=parseFloat(document.getElementById('eDist').value)||0, m=parseFloat(document.getElementById('eMil').value)||1, r=parseFloat(document.getElementById('eRate').value)||0;
    const h=parseFloat(document.getElementById('eHotel').value)||0, o=parseFloat(document.getElementById('eOther').value)||0, p=parseFloat(document.getElementById('ePpl').value)||1;
    const tot=Math.round((d/m)*r + h + o); document.getElementById('rTot').innerText=tot; document.getElementById('rHead').innerText=Math.round(tot/p); document.getElementById('estRes').classList.remove('hidden');
}

// POSTS
function encImg(i){imgs=[];if(i.files)Array.from(i.files).forEach(f=>{const r=new FileReader();r.onload=e=>{const c=document.createElement('canvas'),x=c.getContext('2d'),w=500,i=new Image();i.src=e.target.result;i.onload=()=>{const sc=w/i.width;c.width=w;c.height=i.height*sc;x.drawImage(i,0,0,w,c.height);imgs.push(c.toDataURL('image/jpeg',0.6));}};r.readAsDataURL(f);});}
function saveMem(type){
    const t=document.getElementById('mTxt').value, l=document.getElementById('mLoc').value; if(!t)return;
    const p={who:user.name,txt:t,loc:l,imgs:imgs,t:Date.now()};
    if(type==='trip') db.ref('trips/'+tid+'/highlights').set([...safe(trip.highlights),p]);
    else db.ref('global_public_feed').push(p);
    alert("Posted!"); toggle('formMem'); imgs=[];
}
function renderFeed(){
    const d=document.getElementById('feedArea'); d.innerHTML="";
    safe(trip.highlights).reverse().forEach(h=>{
        let im=""; if(h.imgs)h.imgs.forEach(i=>im+=`<img src="${i}" class="feed-img">`);
        const del = (h.who===user.name || user.name===trip.head) ? `<i class="bi bi-trash text-danger position-absolute top-0 end-0 m-2 bg-white p-1 rounded action-icon" onclick="delPost('${h.t}')"></i>` : "";
        d.innerHTML+=`<div class="vibrant-card p-0 overflow-hidden position-relative">${del}<div class="p-3"><b>${h.who}</b> <small class="text-muted">at ${h.loc||"Unknown"}</small><p>${h.txt}</p></div>${im}</div>`;
    });
}
function delPost(t){if(confirm("Delete?"))db.ref('trips/'+tid+'/highlights').set(safe(trip.highlights).filter(h=>h.t!=t));}

// WORLD FEED CONTROL
function loadWorld(){
    db.ref('global_public_feed').limitToLast(10).on('value',s=>{
        const d=document.getElementById('globalFeed');d.innerHTML="";
        const data = s.val() || {};
        Object.keys(data).reverse().forEach(key=>{
            const k = data[key];
            let im="";if(k.imgs)k.imgs.forEach(i=>im+=`<img src="${i}" class="feed-img">`);
            let ctrls = (k.who === user.name) ? 
                `<div class="d-flex justify-content-end gap-2 p-2"><button class="btn btn-sm btn-light border" onclick="editW('${key}','${k.txt}')">‚úèÔ∏è Edit</button><button class="btn btn-sm btn-danger" onclick="delW('${key}')">üóëÔ∏è Delete</button></div>` : "";
            d.innerHTML+=`<div class="vibrant-card p-0 overflow-hidden bg-white"><div class="p-3"><b>${k.who}</b> <small class="text-muted">at ${k.loc||"Unknown"}</small><p>${k.txt}</p></div>${im}${ctrls}</div>`;
        });
    });
}
function delW(k){ if(confirm("Delete this post?")) db.ref('global_public_feed/'+k).remove(); }
function editW(k, old){ const n = prompt("Update Caption:", old); if(n) db.ref('global_public_feed/'+k).update({txt:n}); }

function donate(){ const a=prompt("Amount:"); if(a){ const l=`upi://pay?pa=${UPI_ID}&pn=${DEV_NAME}&am=${a}&cu=INR`; document.getElementById('qrModal').style.display='flex'; document.getElementById('dAmt').innerText=a; document.getElementById('dLink').href=l; document.getElementById('dQr').innerHTML=`<img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(l)}">`; } }
</script>
</body>
</html>

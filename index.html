<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GHUMO PRO - Material Classic</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body { 
            background-color: #e0e0e0; 
            font-family: 'Roboto', sans-serif; 
            color: #333;
            padding-bottom: 30px;
            user-select: none;
        }

        /* --- MATERIAL CLASSIC THEME --- */
        
        /* HEADER */
        .mat-header {
            background: #009688; /* Teal */
            color: white;
            padding: 16px 20px;
            position: sticky; top: 0; z-index: 1000;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .header-title { font-size: 1.25rem; font-weight: 500; letter-spacing: 0.5px; }

        /* CARDS */
        .mat-card {
            background: white;
            border-radius: 4px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            border-top: 4px solid transparent; /* For accent colors */
        }

        /* BUTTONS */
        .mat-btn {
            border: none;
            border-radius: 4px;
            padding: 10px 16px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: white;
            width: 100%;
            box-shadow: 0 2px 2px 0 rgba(0,0,0,0.14), 0 3px 1px -2px rgba(0,0,0,0.12), 0 1px 5px 0 rgba(0,0,0,0.2);
            transition: 0.2s;
        }
        .mat-btn:active { box-shadow: 0 0 0; transform: translateY(1px); }
        
        .btn-orange { background: #ff5722; } /* Primary Action */
        .btn-green { background: #4caf50; }  /* Deposit/Save */
        .btn-blue { background: #2196f3; }   /* Info/Transport */
        .btn-red { background: #f44336; }    /* Delete/Exit */
        .btn-dark { background: #455a64; }   /* Secondary */

        /* INPUTS */
        .mat-input {
            border: none;
            border-bottom: 2px solid #bdbdbd;
            background: #f5f5f5;
            padding: 10px;
            width: 100%;
            margin-bottom: 10px;
            outline: none;
            border-radius: 4px 4px 0 0;
            transition: 0.3s;
        }
        .mat-input:focus { border-bottom: 2px solid #009688; background: #e0f2f1; }

        /* STATS */
        .stat-val { font-size: 1.8rem; font-weight: 700; color: #009688; }
        .stat-label { font-size: 0.8rem; color: #757575; text-transform: uppercase; font-weight: bold; }

        /* LIST ITEMS */
        .list-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px 0; border-bottom: 1px solid #eee; 
        }
        .list-item:last-child { border-bottom: none; }

        /* HEAD BADGE */
        .head-badge {
            background: #ffc107;
            color: #3e2723;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        /* MODALS */
        .custom-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; }
        .modal-box { background: white; padding: 24px; border-radius: 4px; width: 90%; max-width: 350px; text-align: center; position: relative; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #757575; }

        /* UTILS */
        .hidden { display: none !important; }
        .full-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; display: flex; align-items: center; justify-content: center; background: #009688; }
        .toggle-form { display: none; margin-top: 10px; background: #fafafa; padding: 10px; border: 1px solid #eee; }
        .feed-img { width: 100%; height: 250px; object-fit: cover; margin-top: 10px; border-radius: 2px; }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<div id="estModal" class="custom-modal"><div class="modal-box"><span class="close-btn" onclick="closeModal('estModal')">√ó</span><h5 class="text-primary fw-bold">üìä Estimate Budget</h5><div class="text-start small fw-bold text-muted mt-2">TRAVEL</div><input type="number" id="eTravel" class="mat-input" placeholder="Total Travel Cost"><div class="text-start small fw-bold text-muted mt-2">STAY & FOOD</div><input type="number" id="eHotel" class="mat-input" placeholder="Hotel Cost"><input type="number" id="eOther" class="mat-input" placeholder="Misc/Food"><div class="text-start small fw-bold text-muted mt-2">MEMBERS</div><input type="number" id="ePpl" class="mat-input" placeholder="No. of People" value="1"><button class="mat-btn btn-blue mt-3" onclick="calcEst()">Save Estimate</button></div></div>

<div id="headSetupModal" class="custom-modal"><div class="modal-box"><span class="close-btn" onclick="closeModal('headSetupModal')">√ó</span><h5>Head UPI Setup</h5><input type="text" id="headUPIInput" class="mat-input mt-3" placeholder="Enter UPI ID"><button class="mat-btn btn-blue" onclick="saveHeadUPI()">Save</button></div></div>

<div id="payHeadModal" class="custom-modal"><div class="modal-box"><span class="close-btn" onclick="closeModal('payHeadModal')">√ó</span><h5 class="text-primary">Pay Head</h5><p id="hName" class="small text-muted">--</p><div id="hQr" class="my-2"></div><h3 class="mt-2">‚Çπ<span id="hAmt">0</span></h3><a id="hLink" class="mat-btn btn-green mb-2" href="#">Pay Now</a><button class="mat-btn btn-dark" onclick="confPay()">‚úÖ Confirm Payment</button></div></div>

<div id="qrModal" class="custom-modal"><div class="modal-box"><span class="close-btn" onclick="closeModal('qrModal')">√ó</span><h5 class="text-success">Support Dev</h5><div id="dQr" class="my-2"></div><h3 class="mt-2">‚Çπ<span id="dAmt">0</span></h3><a id="dLink" class="mat-btn btn-dark" href="#">Pay UPI</a></div></div>

<div id="authScreen" class="full-screen">
    <div class="mat-card text-center" style="width:300px; padding:30px;">
        <h2 class="fw-bold mb-4" style="color:#009688;">GHUMO</h2>
        <div id="loginForm">
            <input type="number" id="l_mobile" class="mat-input" placeholder="Mobile Number">
            <input type="password" id="l_pass" class="mat-input" placeholder="Password">
            <button class="mat-btn btn-orange mb-3" onclick="doLogin()">LOGIN</button>
            <button class="btn btn-link text-muted" style="text-decoration:none;" onclick="showReg()">Create Account</button>
        </div>
        <div id="regForm" class="hidden">
            <input type="text" id="r_name" class="mat-input" placeholder="Full Name">
            <input type="number" id="r_mobile" class="mat-input" placeholder="Mobile">
            <input type="text" id="r_address" class="mat-input" placeholder="Address">
            <input type="password" id="r_pass" class="mat-input" placeholder="Password">
            <button class="mat-btn btn-green mb-3" onclick="doRegister()">REGISTER</button>
            <button class="btn btn-link text-muted" style="text-decoration:none;" onclick="showLogin()">Back</button>
        </div>
    </div>
</div>

<div id="homeScreen" class="hidden">
    <div class="mat-header">
        <div class="header-title">GHUMO <small style="font-size:0.8rem; opacity:0.8;">| <span id="uName">User</span></small></div>
        <i class="bi bi-gear-fill fs-5" style="cursor:pointer;" onclick="openSettings()"></i>
    </div>
    
    <div class="container py-3">
        <div class="row g-2 mb-3">
            <div class="col-6"><button class="mat-btn btn-blue" style="height:80px; display:flex; flex-direction:column; align-items:center; justify-content:center;" onclick="createTrip()"><i class="bi bi-plus-circle fs-3 mb-1"></i> Create</button></div>
            <div class="col-6"><button class="mat-btn btn-dark" style="height:80px; display:flex; flex-direction:column; align-items:center; justify-content:center;" onclick="joinTrip()"><i class="bi bi-rocket-takeoff fs-3 mb-1"></i> Join</button></div>
        </div>

        <div class="mat-card">
            <h6 class="fw-bold mb-3" style="color:#ff5722;">üî• OFFERS</h6>
            <div class="d-flex gap-2 overflow-auto">
                <button class="btn btn-outline-secondary btn-sm" onclick="window.open('https://booking.com')">Hotels</button>
                <button class="btn btn-outline-secondary btn-sm" onclick="window.open('https://makemytrip.com')">Flights</button>
                <button class="btn btn-outline-secondary btn-sm" onclick="window.open('https://amazon.in')">Gear</button>
            </div>
        </div>

        <h6 class="text-secondary fw-bold ps-1 mb-2">MY TRIPS</h6>
        <div id="userTripList"><p class="text-center text-muted small">Loading...</p></div>
        
        <br><button class="mat-btn btn-red mb-4" onclick="donate()">‚ù§Ô∏è Support Dev</button>
        <div id="globalFeed"></div>
    </div>
</div>

<div id="mainApp" class="hidden">
    <div class="mat-header">
        <i class="bi bi-arrow-left fs-4" style="cursor:pointer;" onclick="showHome()"></i>
        <div class="text-center"><span class="header-title" id="tName">Trip</span><br><small id="tCode" style="opacity:0.8"></small></div>
        <div></div>
    </div>

    <div class="container py-3">
        
        <div class="mat-card text-center" style="border-top: 4px solid #ff5722;">
            <div class="d-flex justify-content-between">
                <small class="text-muted fw-bold">ESTIMATED BUDGET</small>
                <i class="bi bi-pencil text-secondary" style="cursor:pointer;" onclick="editDashEst()"></i>
            </div>
            <h2 class="fw-bold m-0" style="color:#333;">‚Çπ<span id="dashEst">0</span></h2>
            <small class="text-muted">Per Person: ‚Çπ<span id="dashPerHead">0</span></small>
        </div>

        <div class="mat-card">
            <div class="row text-center">
                <div class="col-6 border-end">
                    <span class="stat-label">Actual Balance</span><br>
                    <span class="stat-val">‚Çπ<span id="bal">0</span></span>
                </div>
                <div class="col-6">
                    <span class="stat-label">Spent/Head</span><br>
                    <span class="stat-val" style="color:#d32f2f;">‚Çπ<span id="ph">0</span></span>
                </div>
            </div>
        </div>

        <div id="headArea" class="mb-3"></div>

        <div class="row g-2 mb-3">
            <div class="col-6"><button class="mat-btn btn-orange" onclick="toggle('formExp')">Expense</button></div>
            <div class="col-6"><button class="mat-btn btn-green" onclick="toggle('formDep')">Deposit</button></div>
            <div class="col-6"><button class="mat-btn btn-blue" onclick="document.getElementById('estModal').style.display='flex'">Budget</button></div>
            <div class="col-6"><button class="mat-btn btn-dark" onclick="toggle('formMem')">Post</button></div>
        </div>

        <div id="formExp" class="toggle-form">
            <h6 class="text-danger fw-bold">Add Expense</h6>
            <input type="text" id="exR" class="mat-input" placeholder="Item Name">
            <input type="number" id="exA" class="mat-input" placeholder="Amount ‚Çπ">
            <button class="mat-btn btn-orange" onclick="addExp()">Add Expense</button>
        </div>
        <div id="formDep" class="toggle-form">
            <h6 class="text-success fw-bold">Deposit Money</h6>
            <select id="dpM" class="mat-input"></select>
            <input type="number" id="dpA" class="mat-input" placeholder="Amount ‚Çπ">
            <button class="mat-btn btn-green" onclick="addDep()">Add Deposit</button>
        </div>
        <div id="formMem" class="toggle-form">
            <h6 class="text-dark fw-bold">Create Post</h6>
            <input type="text" id="mTxt" class="mat-input" placeholder="Caption...">
            <input type="text" id="mLoc" class="mat-input" placeholder="üìç Location">
            <input type="file" id="mImg" class="mat-input" multiple onchange="encImg(this)">
            <div class="d-flex gap-2 mt-2">
                <button class="mat-btn btn-dark" onclick="saveMem('trip')">Trip Feed</button>
                <button class="mat-btn btn-blue" onclick="saveMem('world')">World Feed</button>
            </div>
        </div>

        <div class="mat-card" style="border-top: 4px solid #2196f3;">
            <h6 class="text-primary fw-bold mb-3">üöå Transport & Route</h6>
            <div class="d-flex gap-2">
                <select id="trMode" class="mat-input w-50"><option>Bus</option><option>Train</option><option>Flight</option><option>Taxi</option></select>
                <input type="number" id="trFare" class="mat-input w-50" placeholder="Fare ‚Çπ">
            </div>
            <div class="d-flex gap-2">
                <input type="text" id="trFrom" class="mat-input" placeholder="From">
                <input type="text" id="trTo" class="mat-input" placeholder="To">
            </div>
            <button class="mat-btn btn-blue mb-2" onclick="addTrans()">Add Route</button>
            <button class="mat-btn btn-green" onclick="shareRoute()">üì≤ Share Itinerary</button>
        </div>

        <div class="mat-card">
            <h6 class="stat-label mb-2">RECENT ACTIVITY</h6>
            <div id="actList" style="max-height:300px; overflow-y:auto;"></div>
        </div>

        <div class="mat-card">
            <h6 class="fw-bold mb-2">Members <small class="text-muted fw-normal">(Tap name for Head)</small></h6>
            <div id="memList" class="d-flex flex-wrap gap-2"></div>
        </div>

        <button class="mat-btn btn-red mt-3 mb-4" onclick="exitTrip()">üö™ Exit Trip</button>

        <h6 class="stat-label mt-4 mb-2">MEMORIES</h6>
        <div id="feedArea"></div>
        <div class="mat-card mt-3" style="background:#333; color:white;"><h6 class="text-warning">Final Settlement</h6><div id="finalList" class="small mt-2"></div></div>
    </div>
</div>

<div id="settingsScreen" class="hidden full-screen" style="background:#e0e0e0; z-index:3000; overflow-y:auto; display:block;">
    <div class="mat-header"><i class="bi bi-arrow-left fs-3" style="cursor:pointer;" onclick="showHome()"></i> Settings <div></div></div>
    <div class="container text-center py-5">
        <div class="mat-card">
            <h4 id="setName">--</h4>
            <input type="text" id="upN" class="mat-input" placeholder="Name">
            <input type="text" id="upP" class="mat-input" placeholder="Password">
            <button class="mat-btn btn-blue mb-3" onclick="updProf()">Update Profile</button>
        </div>
        <button class="mat-btn btn-dark mb-3" onclick="alert('App Version 6.0\nDev: '+DEV_NAME)">‚ÑπÔ∏è About App</button>
        <button class="mat-btn btn-red" onclick="doLogout()">Log Out</button>
    </div>
</div>

<script>
// CONFIG
const DEV_NAME="ANKIT KUMAR KASHYAP", UPI_ID="9873502514kotak@ybl";
const firebaseConfig = { apiKey: "AIzaSyCp_ctBvgHAmqxpU9xDbxaufDftKulcJXk", authDomain: "akproject-176c7.firebaseapp.com", databaseURL: "https://akproject-176c7-default-rtdb.firebaseio.com", projectId: "akproject-176c7", storageBucket: "akproject-176c7.firebasestorage.app", messagingSenderId: "769234833598", appId: "1:769234833598:web:db90a08802c07d94810eef" };
firebase.initializeApp(firebaseConfig); const db=firebase.database();
let user=null, tid="", trip={}, imgs=[], hPay=0, tripRef=null;
function safe(d){return d?(Array.isArray(d)?d:Object.values(d)):[];}
function closeModal(id){document.getElementById(id).style.display='none';}
function toggle(id){const e=document.getElementById(id);e.style.display=(e.style.display==='block'?'none':'block');}

// AUTH
window.onload=()=>{
    const s=localStorage.getItem('yatra_user');
    if(s){ user=JSON.parse(s); document.getElementById('uName').innerText=user.name; showHome(); } 
    else document.getElementById('authScreen').classList.remove('hidden');
};
function hideAll(){ ['authScreen','homeScreen','mainApp','settingsScreen'].forEach(i=>document.getElementById(i).classList.add('hidden')); }
function showHome(){ hideAll(); document.getElementById('homeScreen').classList.remove('hidden'); loadTrips(); loadWorld(); }
function openSettings(){ hideAll(); document.getElementById('settingsScreen').classList.remove('hidden'); document.getElementById('setName').innerText=user.name; document.getElementById('upN').value=user.name; document.getElementById('upP').value=user.password; }

function doLogin(){
    const m=document.getElementById('l_mobile').value,p=document.getElementById('l_pass').value; if(!m||!p)return;
    db.ref('users/'+m).once('value',s=>{
        if(s.exists()&&s.val().password==p){ user=s.val(); localStorage.setItem('yatra_user',JSON.stringify(user)); document.getElementById('uName').innerText=user.name; showHome(); }
        else alert("Invalid Credentials");
    });
}
function doRegister(){
    const n=document.getElementById('r_name').value,m=document.getElementById('r_mobile').value,p=document.getElementById('r_pass').value;
    if(n&&m&&p) db.ref('users/'+m).set({name:n,mobile:m,password:p,history:[]}).then(()=>{alert("Created!");toggle('regForm');toggle('loginForm');});
}
function showReg(){ toggle('loginForm'); toggle('regForm'); }
function doLogout(){ localStorage.removeItem('yatra_user'); location.reload(); }
function updProf(){ const n=document.getElementById('upN').value, p=document.getElementById('upP').value; if(n) db.ref('users/'+user.mobile).update({name:n,password:p}).then(()=>{user.name=n;localStorage.setItem('yatra_user',JSON.stringify(user));alert("Updated!");showHome();}); }

// TRIP
function createTrip(){const n=prompt("Name:");if(n){const id="T"+Math.floor(10000+Math.random()*90000);db.ref('trips/'+id).set({name:n,members:[user.name]}).then(()=>{addHist(id);enterTrip(id);});}}
function joinTrip(){const i=prompt("Code:");if(i)db.ref('trips/'+i.toUpperCase()).once('value',s=>{if(s.exists()){addHist(i.toUpperCase());enterTrip(i.toUpperCase());}else alert("Invalid");});}
function addHist(id){db.ref('users/'+user.mobile+'/history').once('value',s=>{let h=safe(s.val());if(!h.includes(id)){h.push(id);db.ref('users/'+user.mobile+'/history').set(h);}});}
function loadTrips(){db.ref('users/'+user.mobile+'/history').on('value',async s=>{const l=document.getElementById('userTripList');l.innerHTML="";const c=safe(s.val());if(!c.length){l.innerHTML="<p class='text-center text-muted'>No trips.</p>";return;}for(const i of c){const sp=await db.ref('trips/'+i).once('value');if(sp.exists())l.innerHTML+=`<div class="mat-card d-flex justify-content-between p-3 mb-2" onclick="enterTrip('${i}')"><b>${sp.val().name}</b><small>${i}</small></div>`;}});}

function enterTrip(id){
    tid=id; hideAll(); document.getElementById('mainApp').classList.remove('hidden');
    db.ref('trips/'+tid).once('value', s => { let t = s.val(); if(t) { let m = safe(t.members); if(!m.includes(user.name)) { m.push(user.name); db.ref('trips/'+tid+'/members').set(m); } } });
    if(tripRef) tripRef.off(); tripRef = db.ref('trips/'+tid);
    tripRef.on('value',s=>{ trip=s.val(); if(!trip) return; renderUI(); });
}
function exitTrip() {
    if(!confirm("Exit Trip?")) return;
    if(trip.head === user.name) { alert("Assign new Head first!"); return; }
    if(tripRef) tripRef.off();
    db.ref('trips/'+tid+'/members').set(safe(trip.members).filter(m => m !== user.name));
    db.ref('users/'+user.mobile+'/history').once('value', s => { db.ref('users/'+user.mobile+'/history').set(safe(s.val()).filter(x => x !== tid)).then(() => { alert("Exited!"); showHome(); }); });
}

function renderUI(){
    document.getElementById('tName').innerText=trip.name; document.getElementById('tCode').innerText=tid;
    const isHead=(user.name.toLowerCase()===(trip.head||"").toLowerCase());
    const hDiv=document.getElementById('headArea'); hDiv.innerHTML=isHead?`<button class="mat-btn btn-blue" onclick="document.getElementById('headSetupModal').style.display='flex'">üè¶ Setup UPI</button>`:(trip.head?`<button class="mat-btn btn-green" onclick="payH()">üí∏ Pay Head</button>`:"");

    document.getElementById('dashEst').innerText = trip.estBudget || 0;
    document.getElementById('dashPerHead').innerText = trip.estPerHead || 0;

    const l=document.getElementById('actList'); l.innerHTML="";
    safe(trip.deposits).slice().reverse().forEach(d=>{
        const del=(d.who===user.name||isHead)?`<i class="bi bi-trash text-danger" onclick="delD(${d.t})" style="cursor:pointer;"></i>`:"";
        l.innerHTML+=`<div class="list-item" style="border-left:4px solid #4caf50; padding-left:10px;"><div><small>${d.who}</small><br><b>+‚Çπ${d.amt}</b></div>${del}</div>`;
    });
    safe(trip.expenses).slice().reverse().forEach(e=>{
        const del=(isHead||e.who===user.name)?`<div class="d-flex gap-2"><i class="bi bi-pencil text-primary" onclick="edE(${e.t},'${e.r}','${e.a}')"></i><i class="bi bi-trash text-danger" onclick="delE(${e.t})"></i></div>`:"";
        l.innerHTML+=`<div class="list-item" style="border-left:4px solid #f44336; padding-left:10px;"><div><small>${e.r}</small><br><b>-‚Çπ${e.a}</b></div>${del}</div>`;
    });

    const ml=document.getElementById('memList'); ml.innerHTML=""; const sl=document.getElementById('dpM'); sl.innerHTML="";
    if(trip.members) trip.members.forEach(m=>{
        const isH=(trip.head&&m.toLowerCase()===trip.head.toLowerCase());
        ml.innerHTML+=`<span class="badge ${isH?'head-badge':'bg-white text-dark border'} p-2 me-1" onclick="mkHead('${m}')">${isH?'üëë':''} ${m}</span>`;
        sl.innerHTML+=`<option value="${m}">${m}</option>`;
    });

    const tin=safe(trip.deposits).reduce((s,x)=>s+x.amt,0), tout=safe(trip.expenses).reduce((s,x)=>s+x.a,0);
    document.getElementById('bal').innerText=tin-tout; 
    document.getElementById('ph').innerText=trip.members ? Math.round(tout/trip.members.length) : 0;
    
    const fl=document.getElementById('finalList'); fl.innerHTML=""; 
    if(trip.members) {
        let avg=Math.round(tout/trip.members.length), pd={};
        trip.members.forEach(m=>pd[m]=0); safe(trip.deposits).forEach(d=>{if(pd[d.who]!==undefined)pd[d.who]+=d.amt;});
        trip.members.forEach(m=>{let b=avg-pd[m]; fl.innerHTML+=`<div class="d-flex justify-content-between border-bottom py-1"><span>${m}</span><span>${b>0?'Pay: '+b:'Get: '+Math.abs(b)}</span></div>`;});
    }
    renderFeed();
}

// ACTIONS
function addExp(){const r=document.getElementById('exR').value,a=parseFloat(document.getElementById('exA').value);if(r&&a){db.ref('trips/'+tid+'/expenses').set([...safe(trip.expenses),{r,a,who:user.name,t:Date.now()}]);toggle('formExp');}}
function addDep(){const w=document.getElementById('dpM').value,a=parseFloat(document.getElementById('dpA').value);if(w&&a){db.ref('trips/'+tid+'/deposits').set([...safe(trip.deposits),{who:w,amt:a,t:Date.now()}]);toggle('formDep');}}
function delE(t){if(confirm("Delete?"))db.ref('trips/'+tid+'/expenses').set(safe(trip.expenses).filter(x=>x.t!==t));}
function delD(t){if(confirm("Delete Deposit?"))db.ref('trips/'+tid+'/deposits').set(safe(trip.deposits).filter(x=>x.t!==t));}
function edE(t,or,oa){const nr=prompt("Item:",or),na=prompt("Amount:",oa);if(nr&&na)db.ref('trips/'+tid+'/expenses').set(safe(trip.expenses).map(x=>x.t===t?{...x,r:nr,a:parseFloat(na)}:x));}
function mkHead(n){if(confirm("Make "+n+" Head?"))db.ref('trips/'+tid+'/head').set(n);}
function saveHeadUPI(){const u=document.getElementById('headUPIInput').value;if(u){db.ref('trips/'+tid+'/headUPI').set(u);closeModal('headSetupModal');}}
function payH(){const a=prompt("Amount:");if(a){if(!trip.headUPI){alert("No UPI");return;}hPay=parseFloat(a);const l=`upi://pay?pa=${trip.headUPI}&pn=${trip.head}&am=${a}&cu=INR`;document.getElementById('payHeadModal').style.display='flex';document.getElementById('hName').innerText="To: "+trip.head;document.getElementById('hAmt').innerText=a;document.getElementById('hLink').href=l;document.getElementById('hQr').innerHTML=`<img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(l)}">`;}}
function confPay(){db.ref('trips/'+tid+'/deposits').set([...safe(trip.deposits),{who:user.name,amt:hPay,t:Date.now()}]);closeModal('payHeadModal');alert("Added!");}
function addTrans(){const m=document.getElementById('trMode').value,f=document.getElementById('trFrom').value,t=document.getElementById('trTo').value,a=parseFloat(document.getElementById('trFare').value);if(f&&t&&a){db.ref('trips/'+tid+'/expenses').set([...safe(trip.expenses),{r:`${m}: ${f} ‚ûî ${t}`,a,who:user.name,t:Date.now()}]);alert("Added!");}}
function shareRoute(){const r=safe(trip.expenses).filter(e=>e.r.includes("‚ûî"));if(!r.length)return alert("No routes");let m=`üöÄ *TRIP PLAN: ${trip.name}*\n\n`,t=0;r.forEach((x,i)=>{m+=`‚úÖ ${x.r} (‚Çπ${x.a})\n`;t+=x.a;});m+=`\nüí∞ Total: ‚Çπ${t}`;window.open(`https://wa.me/?text=${encodeURIComponent(m)}`,'_blank');}
function calcEst(){const t=parseFloat(document.getElementById('eTravel').value)||0;const h=parseFloat(document.getElementById('eHotel').value)||0;const o=parseFloat(document.getElementById('eOther').value)||0;const p=parseFloat(document.getElementById('ePpl').value)||1;const tot = t + h + o;const ph = Math.round(tot / p);db.ref('trips/'+tid).update({estBudget: tot, estPerHead: ph});alert("Saved!");closeModal('estModal');}
function editDashEst() { const newTot = prompt("Enter New Total Budget:", trip.estBudget || 0); if(newTot) { const tot = parseFloat(newTot); const memCount = trip.members ? trip.members.length : 1; const ph = Math.round(tot / memCount); db.ref('trips/'+tid).update({estBudget: tot, estPerHead: ph}); } }
function encImg(i){imgs=[];if(i.files)Array.from(i.files).forEach(f=>{const r=new FileReader();r.onload=e=>{const c=document.createElement('canvas'),x=c.getContext('2d'),w=500,i=new Image();i.src=e.target.result;i.onload=()=>{const sc=w/i.width;c.width=w;c.height=i.height*sc;x.drawImage(i,0,0,w,c.height);imgs.push(c.toDataURL('image/jpeg',0.6));}};r.readAsDataURL(f);});}
function saveMem(type){const t=document.getElementById('mTxt').value, l=document.getElementById('mLoc').value; if(!t)return; const p={who:user.name,txt:t,loc:l,imgs:imgs,t:Date.now()}; if(type==='trip') db.ref('trips/'+tid+'/highlights').set([...safe(trip.highlights),p]); else db.ref('global_public_feed').push(p); alert("Posted!"); toggle('formMem'); imgs=[];}
function renderFeed(){const d=document.getElementById('feedArea'); d.innerHTML=""; safe(trip.highlights).reverse().forEach(h=>{let im=""; if(h.imgs)h.imgs.forEach(i=>im+=`<img src="${i}" class="feed-img">`); const del = (h.who===user.name || user.name===trip.head) ? `<i class="bi bi-trash text-danger" style="float:right; cursor:pointer;" onclick="delPost('${h.t}')"></i>` : ""; d.innerHTML+=`<div class="mat-card p-3 mb-2"><b>${h.who}</b> <small class="text-muted">at ${h.loc||"Unknown"}</small> ${del} <p>${h.txt}</p>${im}</div>`;});}
function delPost(t){if(confirm("Delete?"))db.ref('trips/'+tid+'/highlights').set(safe(trip.highlights).filter(h=>h.t!=t));}
function loadWorld(){db.ref('global_public_feed').limitToLast(10).on('value',s=>{const d=document.getElementById('globalFeed');d.innerHTML=""; const data = s.val() || {}; Object.keys(data).reverse().forEach(key=>{const k = data[key]; let im="";if(k.imgs)k.imgs.forEach(i=>im+=`<img src="${i}" class="feed-img">`); let ctrls = (k.who === user.name) ? `<div style="text-align:right;"><button class="btn btn-sm btn-light border" onclick="editW('${key}','${k.txt}')">‚úèÔ∏è</button><button class="btn btn-sm btn-danger ms-1" onclick="delW('${key}')">üóëÔ∏è</button></div>` : ""; d.innerHTML+=`<div class="mat-card p-3 mb-2"><b>${k.who}</b> <small>at ${k.loc||"Unknown"}</small><p>${k.txt}</p>${im}${ctrls}</div>`;});});}
function delW(k){ if(confirm("Delete?")) db.ref('global_public_feed/'+k).remove(); }
function editW(k, old){ const n = prompt("Update:", old); if(n) db.ref('global_public_feed/'+k).update({txt:n}); }
function donate(){ const a=prompt("Amount:"); if(a){ const l=`upi://pay?pa=${UPI_ID}&pn=${DEV_NAME}&am=${a}&cu=INR`; document.getElementById('qrModal').style.display='flex'; document.getElementById('dAmt').innerText=a; document.getElementById('dLink').href=l; document.getElementById('dQr').innerHTML=`<img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(l)}">`; } }
</script>
</body>
</html>


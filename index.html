<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GHUMO PRO - Premium UI</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            --primary: #4e54c8;
            --secondary: #8f94fb;
            --accent: #ff416c;
            --glass: rgba(255, 255, 255, 0.95);
            --dark-glass: rgba(0, 0, 0, 0.85);
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
            min-height: 100vh;
            color: #333;
            padding-bottom: 80px; /* Space for bottom nav */
        }

        @keyframes gradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        /* HEADER */
        .premium-header {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            border-radius: 0 0 30px 30px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        /* CARDS & GLASS */
        .glass-card {
            background: var(--glass);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: var(--shadow);
            padding: 15px;
            margin-bottom: 15px;
            transition: transform 0.2s;
        }
        .glass-card:active { transform: scale(0.98); }

        /* ATM CARD STATS */
        .atm-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 20px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 15px 30px rgba(118, 75, 162, 0.4);
            margin-bottom: 20px;
        }
        .atm-card::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200px;
            height: 200px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
        }

        /* ACTION GRID ICONS */
        .action-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .action-item {
            background: white;
            border-radius: 15px;
            padding: 15px 5px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: 0.2s;
        }
        .action-item:active { transform: scale(0.9); }
        .icon-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px auto;
            font-size: 1.5rem;
            color: white;
        }
        .ic-exp { background: linear-gradient(45deg, #ff9966, #ff5e62); box-shadow: 0 5px 15px rgba(255, 94, 98, 0.4); }
        .ic-dep { background: linear-gradient(45deg, #56ab2f, #a8e063); box-shadow: 0 5px 15px rgba(86, 171, 47, 0.4); }
        .ic-mem { background: linear-gradient(45deg, #4568dc, #b06ab3); box-shadow: 0 5px 15px rgba(176, 106, 179, 0.4); }

        /* HEAD BADGE */
        .head-badge {
            background: linear-gradient(45deg, #FDC830, #F37335) !important;
            color: white !important;
            border: none !important;
            font-weight: 700 !important;
            box-shadow: 0 3px 10px rgba(243, 115, 53, 0.4);
            padding: 5px 10px !important;
            border-radius: 20px !important;
        }

        /* BOTTOM NAV */
        .bottom-nav {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(10px);
            padding: 12px 30px;
            border-radius: 50px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 2000;
        }
        .nav-item { color: rgba(255,255,255,0.6); font-size: 1.5rem; cursor: pointer; transition: 0.2s; }
        .nav-item.active { color: #fff; transform: scale(1.2); }
        .nav-center {
            background: #ff416c;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin-top: -30px;
            box-shadow: 0 5px 20px rgba(255, 65, 108, 0.6);
            border: 4px solid rgba(255,255,255,0.2);
        }

        /* UTILS */
        .hidden { display: none; }
        .full-screen { height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #map { height: 200px; width: 100%; border-radius: 15px; }
        
        /* Activity List */
        .activity-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
        .activity-icon { width: 40px; height: 40px; border-radius: 12px; background: #f0f2f5; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 1.2rem; }
        
        /* Modals */
        #qrModal, #aboutModal, #headSetupModal, #payHeadModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { background: white; padding: 25px; border-radius: 25px; text-align: center; width: 85%; max-width: 350px; position: relative; animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<div id="qrModal"><div class="modal-box"><h5 class="fw-bold mb-3 text-success">Support Dev</h5><div id="qrImage"></div><h3 class="mt-2">‚Çπ<span id="qrAmount">0</span></h3><a id="payLink" href="#" class="btn btn-dark w-100 rounded-pill mt-2">Pay via UPI</a><br><button onclick="closeModal('qrModal')" class="btn btn-link text-muted mt-2">Close</button></div></div>
<div id="payHeadModal"><div class="modal-box"><h5 class="fw-bold text-primary">Pay to Head</h5><p class="small text-muted" id="headNameDisplay">--</p><div id="headQrImage"></div><h3 class="mt-2">‚Çπ<span id="headPayAmt">0</span></h3><a id="headPayLink" href="#" class="btn btn-success w-100 rounded-pill mb-2">Open UPI App</a><button class="btn btn-outline-dark w-100 rounded-pill" onclick="confirmHeadPayment()">‚úÖ I Have Paid</button><br><button onclick="closeModal('payHeadModal')" class="btn btn-link text-muted mt-2">Close</button></div></div>
<div id="headSetupModal"><div class="modal-box"><h5>üè¶ Setup UPI</h5><input type="text" id="headUPIInput" class="form-control mb-3 rounded-pill" placeholder="e.g. name@oksbi"><button class="btn btn-primary w-100 rounded-pill" onclick="saveHeadUPI()">Save</button><button onclick="closeModal('headSetupModal')" class="btn btn-link text-muted mt-2">Close</button></div></div>
<div id="aboutModal"><div class="modal-box"><img src="https://cdn-icons-png.flaticon.com/512/201/201623.png" width="50" class="mb-3"><h4>GHUMO PRO</h4><p class="small text-muted">Version 5.0 (UI Remastered)</p><hr><p class="small"><b>Dev:</b> <span id="devNameAbout">--</span></p><button class="btn btn-dark w-100 rounded-pill" onclick="closeModal('aboutModal')">Close</button></div></div>

<div id="authScreen" class="full-screen">
    <div class="glass-card text-center" style="width: 320px; padding: 40px 20px;">
        <h1 class="fw-bold mb-0" style="background: -webkit-linear-gradient(#ff416c, #ff4b2b); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">GHUMO</h1>
        <p class="text-muted small mb-4">Travel Together, Smartly.</p>
        
        <div id="loginForm">
            <input type="number" id="l_mobile" class="form-control mb-3 rounded-pill" placeholder="Mobile Number" style="background:#f0f2f5; border:none; padding:12px 20px;">
            <input type="password" id="l_pass" class="form-control mb-4 rounded-pill" placeholder="Password" style="background:#f0f2f5; border:none; padding:12px 20px;">
            <button class="btn btn-dark w-100 rounded-pill py-2 fw-bold" onclick="doLogin()" style="background: linear-gradient(to right, #11998e, #38ef7d); border:none;">LOGIN</button>
            <button class="btn btn-link mt-3 text-muted" onclick="showReg()">Create New Account</button>
        </div>
        
        <div id="regForm" class="hidden">
            <input type="text" id="r_name" class="form-control mb-2 rounded-pill" placeholder="Full Name">
            <input type="number" id="r_mobile" class="form-control mb-2 rounded-pill" placeholder="Mobile">
            <input type="text" id="r_address" class="form-control mb-2 rounded-pill" placeholder="Address">
            <input type="password" id="r_pass" class="form-control mb-3 rounded-pill" placeholder="Password">
            <button class="btn btn-dark w-100 rounded-pill py-2 fw-bold" onclick="doRegister()">REGISTER</button>
            <button class="btn btn-link mt-2 text-muted" onclick="showLogin()">Back to Login</button>
        </div>
    </div>
    <small class="text-white mt-4 opacity-50">Developed by <span class="devNameDisplay"></span></small>
</div>

<div id="homeScreen" class="hidden">
    <div class="premium-header">
        <div>
            <small class="d-block opacity-75">Welcome back,</small>
            <span class="fw-bold fs-5" id="headerUserName">User</span>
        </div>
        <div class="bg-white rounded-circle p-1" style="width:40px; height:40px; overflow:hidden;">
            <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" width="100%">
        </div>
    </div>

    <div class="container py-4">
        <div class="row g-3 mb-4">
            <div class="col-6" onclick="createTrip()">
                <div class="glass-card text-center h-100 d-flex flex-column justify-content-center align-items-center" style="cursor:pointer; background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); color:white; border:none;">
                    <i class="bi bi-plus-circle-fill fs-1 mb-2"></i>
                    <span class="fw-bold">Create Trip</span>
                </div>
            </div>
            <div class="col-6" onclick="joinTrip()">
                <div class="glass-card text-center h-100 d-flex flex-column justify-content-center align-items-center" style="cursor:pointer; background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); color:white; border:none;">
                    <i class="bi bi-rocket-takeoff-fill fs-1 mb-2"></i>
                    <span class="fw-bold">Join Trip</span>
                </div>
            </div>
        </div>

        <h6 class="fw-bold text-white mb-3 ps-2">MY TRIPS</h6>
        <div id="userTripList"><p class="text-center text-white opacity-50">No trips yet.</p></div>
        
        <br><br>
        <h6 class="fw-bold text-white mb-3 ps-2">üî• EXCLUSIVE DEALS</h6>
        <div class="d-flex gap-3" style="overflow-x:auto; padding-bottom:10px;">
            <div class="glass-card text-center" style="min-width:140px;" onclick="window.open('https://www.booking.com','_blank')">
                <i class="bi bi-building fs-1 text-primary"></i><br><small class="fw-bold">Hotels</small>
            </div>
            <div class="glass-card text-center" style="min-width:140px;" onclick="window.open('https://www.makemytrip.com/flights','_blank')">
                <i class="bi bi-airplane-fill fs-1 text-info"></i><br><small class="fw-bold">Flights</small>
            </div>
            <div class="glass-card text-center" style="min-width:140px;" onclick="window.open('https://www.amazon.in/s?k=travel','_blank')">
                <i class="bi bi-bag-fill fs-1 text-warning"></i><br><small class="fw-bold">Gear</small>
            </div>
        </div>
    </div>
</div>

<div id="mainApp" class="hidden">
    <div class="premium-header">
        <i class="bi bi-arrow-left fs-4" onclick="showHome()"></i>
        <div class="text-center">
            <span class="fw-bold" id="dispName">Trip Name</span><br>
            <small class="opacity-75" style="font-size:0.7rem;" id="dispCode">--</small>
        </div>
        <i class="bi bi-gear-fill fs-4" onclick="openSettings()"></i>
    </div>

    <div class="container py-3">
        <div class="atm-card">
            <div class="d-flex justify-content-between">
                <span>Total Balance</span>
                <i class="bi bi-wifi"></i>
            </div>
            <h2 class="fw-bold mt-2">‚Çπ<span id="cashHand">0</span></h2>
            <div class="d-flex justify-content-between mt-4 align-items-end">
                <div>
                    <small class="opacity-75">PER HEAD</small><br>
                    <span class="fw-bold fs-5">‚Çπ<span id="perPersonDisplay">0</span></span>
                </div>
                <img src="https://cdn-icons-png.flaticon.com/512/9334/9334549.png" width="40" style="opacity:0.8">
            </div>
        </div>

        <div id="headActionArea" class="mb-3"></div>

        <div class="action-grid">
            <div class="action-item" onclick="toggleForm('formExp')">
                <div class="icon-circle ic-exp"><i class="bi bi-cash-stack"></i></div>
                <small class="fw-bold">Expense</small>
            </div>
            <div class="action-item" onclick="toggleForm('formDep')">
                <div class="icon-circle ic-dep"><i class="bi bi-piggy-bank-fill"></i></div>
                <small class="fw-bold">Deposit</small>
            </div>
            <div class="action-item" onclick="toggleForm('formMem')">
                <div class="icon-circle ic-mem"><i class="bi bi-camera-reels-fill"></i></div>
                <small class="fw-bold">Memory</small>
            </div>
        </div>

        <div id="formExp" class="glass-card hidden">
            <h6 class="text-danger fw-bold">Add Expense</h6>
            <div class="input-group"><input type="text" id="expRea" class="form-control rounded-start-pill" placeholder="Item"><input type="number" id="expAmt" class="form-control" placeholder="‚Çπ"><button class="btn btn-danger rounded-end-pill" onclick="addExp()">Add</button></div>
        </div>
        <div id="formDep" class="glass-card hidden">
            <h6 class="text-success fw-bold">Cash Deposit</h6>
            <div class="input-group"><select id="depMem" class="form-select rounded-start-pill"></select><input type="number" id="depAmt" class="form-control" placeholder="‚Çπ"><button class="btn btn-success rounded-end-pill" onclick="addDep()">Add</button></div>
        </div>
        <div id="formMem" class="glass-card hidden">
            <h6 class="text-warning fw-bold">Post Memory</h6>
            <input type="text" id="highTxt" class="form-control mb-2 rounded-pill" placeholder="Caption...">
            <input type="file" id="highImg" class="form-control rounded-pill" accept="image/*" multiple onchange="encodeImgs(this)">
            <div id="imgPreview" class="d-flex gap-2 mt-2" style="overflow-x:auto;"></div>
            <button class="btn btn-warning w-100 rounded-pill mt-2 fw-bold" onclick="saveMem('trip')">Share to Trip</button>
        </div>

        <div class="glass-card">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="fw-bold m-0"><i class="bi bi-bus-front-fill text-primary"></i> Transport</h6>
                <select id="transType" class="form-select form-select-sm w-auto rounded-pill" onchange="toggleTransportMode()"><option value="fuel">Car/Fuel</option><option value="public">Bus/Train</option></select>
            </div>
            
            <div id="fuelInputs">
                <div class="input-group input-group-sm"><input type="number" id="fDist" class="form-control" placeholder="KM"><input type="number" id="fMil" class="form-control" placeholder="Avg"><input type="number" id="fRate" class="form-control" placeholder="Price"><button class="btn btn-primary" onclick="addFuel()">Add</button></div>
            </div>
            <div id="publicInputs" class="hidden">
                <div class="row g-2 mb-2"><div class="col-6"><input type="text" id="ptFrom" class="form-control form-control-sm" placeholder="From"></div><div class="col-6"><input type="text" id="ptTo" class="form-control form-control-sm" placeholder="To"></div></div>
                <div class="input-group input-group-sm"><select id="ptMode" class="form-select"><option>Bus</option><option>Train</option><option>Flight</option></select><input type="number" id="ptFare" class="form-control" placeholder="‚Çπ Fare"><button class="btn btn-primary" onclick="addPublicTransport()">Add</button></div>
            </div>
            <button class="btn btn-success btn-sm w-100 mt-2 rounded-pill" onclick="shareFullRoute()"><i class="bi bi-whatsapp"></i> Share Full Itinerary</button>
        </div>

        <div class="glass-card">
            <h6 class="text-muted fw-bold small mb-3">RECENT ACTIVITY</h6>
            <div id="expList" style="max-height:300px; overflow-y:auto; padding-right:5px;"></div>
        </div>

        <div class="glass-card p-2">
            <div class="d-flex justify-content-between align-items-center mb-2 px-2">
                <h6 class="fw-bold m-0 text-danger"><i class="bi bi-geo-alt-fill"></i> Live Map</h6>
                <button id="gpsBtn" class="btn btn-sm btn-danger rounded-pill" onclick="startTracking()">Start GPS</button>
            </div>
            <div id="map"></div>
            <div id="locationList" class="mt-2"></div>
        </div>

        <div class="glass-card">
            <div class="d-flex justify-content-between mb-2"><h6 class="fw-bold m-0">Members</h6><small class="text-primary cursor-pointer" onclick="setHead()">Set Head</small></div>
            <div id="memList" class="d-flex flex-wrap gap-2"></div>
        </div>

        <h6 class="text-white fw-bold ps-2 mt-4">TRIP MEMORIES</h6>
        <div id="tripFeedArea" class="mb-5"></div>
        
        <div class="glass-card bg-dark text-white"><h6 class="text-warning">Final Settlement</h6><div id="finalList" class="small mt-2"></div></div>
    </div>
</div>

<div id="settingsScreen" class="hidden">
    <div class="premium-header"><i class="bi bi-arrow-left fs-4" onclick="showHome()"></i> <span class="fw-bold">Settings</span> <div></div></div>
    <div class="container py-4">
        <div class="glass-card text-center">
            <div class="bg-light rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width:80px; height:80px; font-size:2rem;">üë§</div>
            <h4 id="s_name">--</h4>
            <input type="text" id="up_name" class="form-control mb-2 rounded-pill mt-3" placeholder="Name">
            <input type="text" id="up_address" class="form-control mb-2 rounded-pill" placeholder="Address">
            <input type="text" id="up_pass" class="form-control mb-3 rounded-pill" placeholder="Password">
            <button class="btn btn-primary w-100 rounded-pill" onclick="saveSettings()">Save Changes</button>
        </div>
        <div class="glass-card p-0 overflow-hidden">
            <button class="btn btn-light w-100 text-start p-3 border-bottom" onclick="document.getElementById('aboutModal').style.display='flex'">‚ÑπÔ∏è About App</button>
            <button class="btn btn-light w-100 text-start p-3 border-bottom text-danger" onclick="donateUPI()">‚ù§Ô∏è Support Developer</button>
            <button class="btn btn-light w-100 text-start p-3 text-danger" onclick="doLogout()">üö™ Log Out</button>
        </div>
    </div>
</div>

<div class="bottom-nav hidden" id="bottomNav">
    <i class="bi bi-house-door-fill nav-item active" onclick="showHome()"></i>
    <div class="nav-center" onclick="showHome()"><i class="bi bi-grid-fill"></i></div> <i class="bi bi-person-fill nav-item" onclick="openSettings()"></i>
</div>

<script>
// --- CONFIG ---
const DEV_NAME = "YOUR NAME"; 
const DEV_UPI_ID = "YOUR_UPI"; 

const firebaseConfig = {
      apiKey: "AIzaSyCp_ctBvgHAmqxpU9xDbxaufDftKulcJXk",
      authDomain: "akproject-176c7.firebaseapp.com",
      databaseURL: "https://akproject-176c7-default-rtdb.firebaseio.com",
      projectId: "akproject-176c7",
      storageBucket: "akproject-176c7.firebasestorage.app",
      messagingSenderId: "769234833598",
      appId: "1:769234833598:web:db90a08802c07d94810eef"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let user=null, tid="", tripData={}, tempImages=[], headPayAmt=0, watchId=null, myLat=null, myLng=null;
function safeArray(d){ return d ? (Array.isArray(d)?d:Object.values(d)) : []; }
function closeModal(id){ document.getElementById(id).style.display='none'; }

// AUTH & NAV
window.onload = () => { document.querySelectorAll('.devNameDisplay').forEach(e=>e.innerText=DEV_NAME); const s=localStorage.getItem('yatra_user'); if(s){ user=JSON.parse(s); document.getElementById('headerUserName').innerText=user.name; showHome(); } else { document.getElementById('authScreen').style.display='flex'; } };
function hideAll() { ['authScreen','homeScreen','mainApp','settingsScreen'].forEach(i=>document.getElementById(i).classList.add('hidden')); document.getElementById('bottomNav').classList.add('hidden'); }
function showLogin() { hideAll(); document.getElementById('authScreen').style.display='flex'; document.getElementById('authScreen').classList.remove('hidden'); document.getElementById('loginForm').classList.remove('hidden'); document.getElementById('regForm').classList.add('hidden'); }
function showReg() { document.getElementById('loginForm').classList.add('hidden'); document.getElementById('regForm').classList.remove('hidden'); }
function showHome() { hideAll(); document.getElementById('homeScreen').classList.remove('hidden'); document.getElementById('bottomNav').classList.remove('hidden'); loadTrips(); stopTracking(); }
function openSettings() { hideAll(); document.getElementById('settingsScreen').classList.remove('hidden'); document.getElementById('bottomNav').classList.remove('hidden'); db.ref('users/'+user.mobile).once('value',s=>{const u=s.val();document.getElementById('s_name').innerText=u.name;document.getElementById('up_name').value=u.name;document.getElementById('up_address').value=u.address||"";document.getElementById('up_pass').value=u.password;}); }
function toggleForm(id) { const el=document.getElementById(id); el.classList.toggle('hidden'); }

// --- LOGIC ---
function doRegister(){const n=document.getElementById('r_name').value,m=document.getElementById('r_mobile').value,a=document.getElementById('r_address').value,p=document.getElementById('r_pass').value; if(n&&m&&a&&p) db.ref('users/'+m).set({name:n,mobile:m,address:a,password:p,history:[]}).then(()=>{alert("Created!");showLogin();});}
function doLogin(){const m=document.getElementById('l_mobile').value,p=document.getElementById('l_pass').value; if(!m||!p)return; db.ref('users/'+m).once('value',s=>{if(s.exists()&&s.val().password==p){user=s.val();localStorage.setItem('yatra_user',JSON.stringify(user));document.getElementById('headerUserName').innerText=user.name;showHome();}else alert("Invalid");});}
function doLogout(){localStorage.removeItem('yatra_user');location.reload();}
function saveSettings(){const n=document.getElementById('up_name').value,a=document.getElementById('up_address').value,p=document.getElementById('up_pass').value; if(n) db.ref('users/'+user.mobile).update({name:n,address:a,password:p}).then(()=>{user.name=n;localStorage.setItem('yatra_user',JSON.stringify(user));alert("Saved!");showHome();});}

function createTrip(){const n=prompt("Trip Name:");if(n){const id="T"+Math.floor(10000+Math.random()*90000);db.ref('trips/'+id).set({name:n,members:[user.name]}).then(()=>{addHistory(id);enterTrip(id);});}}
function joinTrip(){const id=prompt("Code:");if(id)db.ref('trips/'+id.toUpperCase()).once('value',s=>{if(s.exists()){addHistory(id.toUpperCase());enterTrip(id.toUpperCase());}else alert("Invalid");});}
function addHistory(id){db.ref('users/'+user.mobile+'/history').once('value',s=>{let h=safeArray(s.val());if(!h.includes(id)){h.push(id);db.ref('users/'+user.mobile+'/history').set(h);}});}
function deleteTrip(id,e){e.stopPropagation();if(confirm("Delete?"))db.ref('users/'+user.mobile+'/history').once('value',s=>{db.ref('users/'+user.mobile+'/history').set(safeArray(s.val()).filter(x=>x!==id));});}
function loadTrips(){db.ref('users/'+user.mobile+'/history').on('value',async s=>{const l=document.getElementById('userTripList');l.innerHTML="";const c=safeArray(s.val());if(c.length===0){l.innerHTML="<p class='text-white text-center opacity-50'>No trips.</p>";return;}for(const i of c){const sp=await db.ref('trips/'+i).once('value');if(sp.exists()){l.innerHTML+=`<div class="glass-card d-flex justify-content-between align-items-center" onclick="enterTrip('${i}')"><div><b>${sp.val().name}</b><br><small class="opacity-75">${i}</small></div><i class="bi bi-trash text-danger" onclick="deleteTrip('${i}',event)"></i></div>`;}}});}

function enterTrip(id){tid=id;hideAll();document.getElementById('mainApp').classList.remove('hidden');db.ref('trips/'+tid).on('value',s=>{tripData=s.val();if(!tripData)return;let m=safeArray(tripData.members);if(!m.includes(user.name)){m.push(user.name);db.ref('trips/'+tid+'/members').set(m);}tripData.members=m;renderUI();renderTripFeed();if(tripData.locations)renderLocs(tripData.locations);});}

function renderUI(){
    document.getElementById('dispName').innerText=tripData.name; document.getElementById('dispCode').innerText=tid;
    const isHead=(user.name.toLowerCase()===(tripData.head||"").toLowerCase());
    const hDiv=document.getElementById('headActionArea'); hDiv.innerHTML="";
    if(isHead) hDiv.innerHTML=`<button class="btn btn-warning w-100 rounded-pill fw-bold shadow" onclick="document.getElementById('headSetupModal').style.display='flex'">üè¶ Setup UPI Collection</button>`;
    else if(tripData.head) hDiv.innerHTML=`<button class="btn btn-success w-100 rounded-pill fw-bold shadow" onclick="payHead()">üí∏ Pay to Head Online</button>`;

    const l=document.getElementById('expList'); l.innerHTML="";
    safeArray(tripData.deposits).slice().reverse().forEach(d=>{l.innerHTML+=`<div class="d-flex align-items-center mb-2 p-2 bg-white rounded shadow-sm" style="border-left:4px solid #2ecc71"><div class="flex-grow-1 ms-2"><small class="text-muted">${new Date(d.t).toLocaleDateString()}</small><br><b>${d.who}</b> Deposited</div><b class="text-success">+‚Çπ${d.amt}</b></div>`;});
    safeArray(tripData.expenses).slice().reverse().forEach(e=>{
        const isR=e.r.includes("‚ûî"); const share=isR?`<i class="bi bi-whatsapp text-success ms-2" onclick="shareR('${e.r}',${e.a})"></i>`:"";
        const del=isHead?`<i class="bi bi-trash text-danger ms-2" onclick="delExp(${e.t})"></i>`:"";
        l.innerHTML+=`<div class="d-flex align-items-center mb-2 p-2 bg-white rounded shadow-sm" style="border-left:4px solid #e74c3c"><div class="flex-grow-1 ms-2"><small class="text-muted">${new Date(e.t).toLocaleDateString()}</small><br><span>${e.r}</span></div><div class="text-end"><b class="text-danger">-‚Çπ${e.a}</b><br>${share}${del}</div></div>`;
    });

    const mDiv=document.getElementById('memList'); mDiv.innerHTML=""; const sel=document.getElementById('depMem'); sel.innerHTML="";
    tripData.members.forEach(m=>{
        const isH=(tripData.head&&m.toLowerCase()===tripData.head.toLowerCase());
        mDiv.innerHTML+=`<span class="badge ${isH?'head-badge':'bg-white text-dark'} p-2 border">${isH?'üëë':''} ${m}</span>`;
        sel.innerHTML+=`<option value="${m}">${m}</option>`;
    });

    const tin=safeArray(tripData.deposits).reduce((s,x)=>s+x.amt,0), tout=safeArray(tripData.expenses).reduce((s,x)=>s+x.a,0);
    document.getElementById('cashHand').innerText=tin-tout; 
    document.getElementById('perPersonDisplay').innerText=tripData.members.length?Math.round(tout/tripData.members.length):0;
    
    // Settlement
    const fDiv=document.getElementById('finalList'); fDiv.innerHTML=""; let ph=Math.round(tout/tripData.members.length), pd={};
    tripData.members.forEach(m=>pd[m]=0); safeArray(tripData.deposits).forEach(d=>{if(pd[d.who]!==undefined)pd[d.who]+=d.amt;});
    tripData.members.forEach(m=>{let b=ph-pd[m]; fDiv.innerHTML+=`<div class="d-flex justify-content-between border-bottom border-secondary py-1"><span>${m}</span><span>${b>0?'Pay: '+b:'Get: '+Math.abs(b)}</span></div>`;});
}

// ACTIONS
function addExp(){const r=document.getElementById('expRea').value,a=parseFloat(document.getElementById('expAmt').value);if(r&&a){db.ref('trips/'+tid+'/expenses').set([...safeArray(tripData.expenses),{r,a,t:Date.now()}]);toggleForm('formExp');}}
function addDep(){const w=document.getElementById('depMem').value,a=parseFloat(document.getElementById('depAmt').value);if(w&&a){db.ref('trips/'+tid+'/deposits').set([...safeArray(tripData.deposits),{who:w,amt:a,t:Date.now()}]);toggleForm('formDep');}}
function delExp(t){if(confirm("Delete?"))db.ref('trips/'+tid+'/expenses').set(safeArray(tripData.expenses).filter(x=>x.t!==t));}
function setHead(){const h=prompt("Head Name:");if(h)db.ref('trips/'+tid+'/head').set(h);}
function saveHeadUPI(){const u=document.getElementById('headUPIInput').value;if(u){db.ref('trips/'+tid+'/headUPI').set(u);closeModal('headSetupModal');}}
function payHead(){const a=prompt("Amount:");if(a){if(!tripData.headUPI){alert("No UPI Set");return;} headPayAmt=parseFloat(a); const l=`upi://pay?pa=${tripData.headUPI}&pn=${tripData.head}&am=${a}&cu=INR`; document.getElementById('payHeadModal').style.display='flex'; document.getElementById('headNameDisplay').innerText="To: "+tripData.head; document.getElementById('headPayAmt').innerText=a; document.getElementById('headPayLink').href=l; document.getElementById('headQrImage').innerHTML=`<img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(l)}">`; }}
function confirmHeadPayment(){db.ref('trips/'+tid+'/deposits').set([...safeArray(tripData.deposits),{who:user.name,amt:headPayAmt,t:Date.now()}]);closeModal('payHeadModal');alert("Added!");}
function donateUPI(){const a=prompt("Amount:");if(a){const l=`upi://pay?pa=${DEV_UPI_ID}&pn=${DEV_NAME}&am=${a}&cu=INR`; document.getElementById('qrModal').style.display='flex'; document.getElementById('qrAmount').innerText=a; document.getElementById('payLink').href=l; document.getElementById('qrImage').innerHTML=`<img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(l)}">`;}}

// TRANSPORT
function toggleTransportMode(){const m=document.getElementById('transType').value;document.getElementById('fuelInputs').classList.toggle('hidden',m!=='fuel');document.getElementById('publicInputs').classList.toggle('hidden',m!=='public');}
function addFuel(){const d=document.getElementById('fDist').value,m=document.getElementById('fMil').value,r=document.getElementById('fRate').value;if(d&&m&&r)db.ref('trips/'+tid+'/expenses').set([...safeArray(tripData.expenses),{r:`‚õΩ Fuel ${d}km`,a:Math.round((d/m)*r),t:Date.now()}]);}
function addPublicTransport(){const f=document.getElementById('ptFrom').value,t=document.getElementById('ptTo').value,m=document.getElementById('ptMode').value,a=parseFloat(document.getElementById('ptFare').value);if(f&&t&&a){db.ref('trips/'+tid+'/expenses').set([...safeArray(tripData.expenses),{r:`${m}: ${f} ‚ûî ${t}`,a,t:Date.now()}]);alert("Added!");}}
function shareR(r,a){window.open(`https://wa.me/?text=${encodeURIComponent(`üöå Route: ${r}\nüí∞ Fare: ‚Çπ${a}\nvia GHUMO PRO`)}`,'_blank');}
function shareFullRoute(){const r=safeArray(tripData.expenses).filter(e=>e.r.includes("‚ûî"));if(!r.length)return alert("No routes");let m=`üöÄ *TRIP PLAN: ${tripData.name}*\n\n`,t=0;r.forEach((x,i)=>{m+=`‚úÖ Step ${i+1}: ${x.r} (‚Çπ${x.a})\n`;t+=x.a;});m+=`\nüí∞ Total Transport: ‚Çπ${t}`;window.open(`https://wa.me/?text=${encodeURIComponent(m)}`,'_blank');}

// MAP & FEED
function startTracking(){if(!navigator.geolocation)return alert("No GPS");document.getElementById('gpsBtn').innerText="ON";watchId=navigator.geolocation.watchPosition(p=>{myLat=p.coords.latitude;myLng=p.coords.longitude;db.ref('trips/'+tid+'/locations/'+user.name).set({lat:myLat,lng:myLng,t:Date.now()});});}
function stopTracking(){if(watchId)navigator.geolocation.clearWatch(watchId);}
function renderLocs(l){const d=document.getElementById('locationList');d.innerHTML="";Object.keys(l).forEach(m=>{if(m===user.name)return;const x=l[m];let dist="";if(myLat){const k=calcDist(myLat,myLng,x.lat,x.lng);dist=`<span class="badge bg-secondary">${k} km</span>`;}d.innerHTML+=`<div class="track-card"><b>${m}</b> ${dist} <a href="http://maps.google.com/?q=${x.lat},${x.lng}" target="_blank" class="track-btn">Track</a></div>`;});}
function calcDist(lat1,lon1,lat2,lon2){const R=6371,dLat=(lat2-lat1)*Math.PI/180,dLon=(lon2-lon1)*Math.PI/180,a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);return(R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))).toFixed(1);}
function renderTripFeed(){const d=document.getElementById('tripFeedArea');d.innerHTML="";safeArray(tripData.highlights).reverse().forEach(h=>{let im="";if(h.imgs)h.imgs.forEach(i=>im+=`<img src="${i}" class="mem-img-full">`);d.innerHTML+=`<div class="glass-card p-0 overflow-hidden"><div class="p-3 bg-white border-bottom d-flex justify-content-between"><b>${h.who}</b><span>${h.txt}</span></div><div class="p-2">${im}</div></div>`;});}
function encodeImgs(i){tempImages=[];if(i.files)Array.from(i.files).forEach(f=>{const r=new FileReader();r.onload=e=>{tempImages.push(e.target.result);document.getElementById('imgPreview').innerHTML+=`<img src="${e.target.result}" class="thumb-img">`;};r.readAsDataURL(f);});}
function saveMem(t){const x=document.getElementById('highTxt').value;if(!x)return;db.ref('trips/'+tid+'/highlights').set([...safeArray(tripData.highlights),{who:user.name,txt:x,imgs:tempImages,t:Date.now()}]);alert("Posted!");toggleForm('formMem');}
</script>
</body>
</html>

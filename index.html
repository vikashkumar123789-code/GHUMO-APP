<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GHUMO PRO - Live Tracking</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        body { background: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        .full-screen { height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #0f2027, #203a43, #2c5364); }
        .card { border-radius: 15px; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .app-header { background: #203a43; color: white; padding: 15px; border-radius: 0 0 20px 20px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        
        /* Menu */
        .menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .menu-content button { width: 260px; margin-bottom: 12px; padding: 12px; border-radius: 30px; font-weight: bold; }
        
        /* Map Styles */
        #map { height: 350px; width: 100%; border-radius: 10px; z-index: 1; }
        .user-marker-label { background: white; padding: 2px 5px; border-radius: 4px; border: 1px solid #333; font-weight: bold; font-size: 10px; white-space: nowrap; }

        /* Other Styles */
        .stat-box { padding: 15px; border-radius: 12px; text-align: center; color: white; height: 100%; }
        .bg-cash { background: linear-gradient(45deg, #11998e, #38ef7d); }
        .bg-head { background: linear-gradient(45deg, #3a7bd5, #00d2ff); }
        .money-out { border-left: 5px solid #e74c3c; background: #fff; padding: 10px; margin-bottom: 5px; border-radius: 5px; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; }
        
        .feed-card { background: white; border-radius: 15px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: relative; }
        .img-scroll-container { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; background: #000; }
        .feed-img { flex: 0 0 100%; width: 100%; height: 300px; object-fit: contain; scroll-snap-align: center; }
        .cost-badge { background: #27ae60; color: white; padding: 4px 10px; border-radius: 15px; font-size: 0.85rem; font-weight: bold; float: right; }
        .preview-box { display: flex; gap: 5px; overflow-x: auto; padding: 5px; }
        .thumb-img { height: 60px; width: 60px; object-fit: cover; border-radius: 5px; border: 1px solid #ccc; }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>

<div id="menuOverlay" class="menu-overlay" onclick="toggleMenu()">
    <div class="menu-content text-center" onclick="event.stopPropagation()">
        <h2 class="text-white mb-4">üåé GHUMO</h2>
        <button class="btn btn-warning text-dark" onclick="menuAction('profile')">üë§ My Profile</button>
        <button class="btn btn-primary" onclick="menuAction('create')">‚ûï Create New Trip</button>
        <button class="btn btn-light" onclick="menuAction('join')">üöÄ Join Trip</button>
        <button class="btn btn-info text-white" onclick="showHome()">üè† Home / Feed</button>
        <hr class="text-white w-75 mx-auto">
        <button class="btn btn-outline-danger" onclick="doUnregister()">‚ùå Delete Account</button>
        <button class="btn btn-danger mt-3" onclick="doLogout()">Log Out</button>
    </div>
</div>

<div id="authScreen" class="full-screen">
    <div class="card p-4 text-center" style="width: 350px;">
        <h1 class="text-primary fw-bold">GHUMO</h1>
        <div id="loginForm">
            <input type="number" id="l_mobile" class="form-control mb-2" placeholder="Mobile">
            <input type="password" id="l_pass" class="form-control mb-2" placeholder="Password">
            <button class="btn btn-primary w-100" onclick="doLogin()">LOGIN</button>
            <button class="btn btn-link mt-2" onclick="showReg()">New Account</button>
        </div>
        <div id="regForm" style="display:none;">
            <input type="text" id="r_name" class="form-control mb-2" placeholder="Name">
            <input type="number" id="r_mobile" class="form-control mb-2" placeholder="Mobile">
            <input type="text" id="r_address" class="form-control mb-2" placeholder="Address">
            <input type="password" id="r_pass" class="form-control mb-2" placeholder="Password">
            <button class="btn btn-success w-100 mt-2" onclick="doRegister()">REGISTER</button>
            <button class="btn btn-link mt-2" onclick="showLogin()">Back</button>
        </div>
    </div>
</div>

<div id="homeScreen" style="display:none; max-width: 500px; margin: auto;">
    <div class="app-header d-flex justify-content-between align-items-center">
        <i class="bi bi-list fs-1" style="cursor:pointer" onclick="toggleMenu()"></i>
        <div class="fw-bold fs-3">GHUMO</div>
        <div style="width:40px"></div>
    </div>
    <div class="container py-3">
        <h6 class="fw-bold text-muted mb-2">MY TRIPS</h6>
        <div id="userTripList"></div>
        <hr>
        <h6 class="text-primary fw-bold mb-3"><i class="bi bi-globe"></i> EXPLORE WORLD</h6>
        <div id="globalFeed"></div>
    </div>
</div>

<div id="profileScreen" style="display:none; max-width: 500px; margin: auto;">
    <div class="app-header d-flex justify-content-between align-items-center">
        <i class="bi bi-arrow-left fs-2" onclick="showHome()"></i>
        <h5 class="m-0">Profile</h5>
        <div style="width:30px"></div>
    </div>
    <div class="container py-4">
        <div class="card p-4 shadow-sm text-center">
            <i class="bi bi-person-circle" style="font-size: 4rem; color:#203a43;"></i>
            <h4 id="p_name">--</h4>
            <p id="p_mobile">--</p>
            <p id="p_addr" class="small text-muted">--</p>
            <hr>
            <h6>Edit</h6>
            <input type="text" id="edit_name" class="form-control mb-2" placeholder="Name">
            <input type="text" id="edit_address" class="form-control mb-2" placeholder="Address">
            <button class="btn btn-dark w-100" onclick="updateProfile()">UPDATE</button>
        </div>
    </div>
</div>

<div id="mainApp" style="display:none; max-width: 500px; margin: auto;">
    <div class="app-header d-flex justify-content-between align-items-center">
        <i class="bi bi-arrow-left fs-2" onclick="showHome()"></i>
        <div class="text-center"><h5 id="dispName" class="m-0 fw-bold">Trip</h5></div>
        <i class="bi bi-list fs-2" onclick="toggleMenu()"></i>
    </div>

    <div class="container p-3 pb-5">
        
        <div class="card p-2 border-primary mb-3 shadow">
            <div class="d-flex justify-content-between align-items-center mb-2 px-2">
                <h6 class="text-primary fw-bold m-0"><i class="bi bi-geo-alt-fill"></i> LIVE TRACKING</h6>
                <button class="btn btn-sm btn-primary" onclick="startTracking()">Start GPS</button>
            </div>
            <div id="map"></div>
            <small class="text-center text-muted mt-1">Tap marker to Follow Member</small>
        </div>

        <div class="row g-3 mb-3">
            <div class="col-6"><div class="stat-box bg-cash shadow-sm"><small>CASH IN HAND</small><h3 class="fw-bold m-0">‚Çπ<span id="cashHand">0</span></h3></div></div>
            <div class="col-6"><div class="stat-box bg-head shadow-sm"><small>PER PERSON</small><h3 class="fw-bold m-0">‚Çπ<span id="perPersonDisplay">0</span></h3></div></div>
        </div>

        <div class="card p-3 border-danger mb-3 shadow-sm">
            <h6 class="text-danger fw-bold">üí∏ EXPENSE</h6>
            <div class="input-group input-group-sm mb-2">
                <input type="text" id="expRea" class="form-control" placeholder="Item Name">
                <input type="number" id="expAmt" class="form-control" placeholder="‚Çπ">
                <button class="btn btn-danger" onclick="addExp()">Add</button>
            </div>
            <div id="expList" style="max-height:150px; overflow:auto;"></div>
        </div>

        <div class="card p-3 border-success mb-3 shadow-sm">
            <h6 class="text-success fw-bold">üí∞ DEPOSIT</h6>
            <div class="input-group input-group-sm">
                <select id="depMem" class="form-select"></select>
                <input type="number" id="depAmt" class="form-control" placeholder="‚Çπ">
                <button class="btn btn-success" onclick="addDep()">Deposit</button>
            </div>
        </div>

        <div class="card p-3 border-info mb-3">
            <h6 class="text-info fw-bold">‚õΩ Transport Cost</h6>
            <div class="input-group input-group-sm">
                <input type="number" id="fDist" class="form-control" placeholder="KM">
                <input type="number" id="fMil" class="form-control" placeholder="Avg">
                <input type="number" id="fRate" class="form-control" placeholder="Price">
                <button class="btn btn-info text-white" onclick="addFuel()">Add</button>
            </div>
        </div>

        <div class="card p-3 mb-3 bg-light">
            <div class="d-flex justify-content-between mb-2">
                <h6 class="m-0">üë• Members</h6>
                <small class="text-warning cursor-pointer" onclick="setHead()">Set Head</small>
            </div>
            <div id="memList" class="d-flex flex-wrap gap-1"></div>
        </div>

        <h6 class="text-muted fw-bold small mt-4">TRIP MEMORIES</h6>
        <div id="tripFeedArea" class="mb-4"></div>

        <div id="memBox" class="card p-3 mt-4 border-warning shadow">
            <h6 class="text-warning fw-bold">üì∏ Share Memory</h6>
            <input type="text" id="highTxt" class="form-control mb-2" placeholder="Caption...">
            <div class="row g-2 mb-2">
                <div class="col-7"><input type="text" id="highLoc" class="form-control" placeholder="Location"></div>
                <div class="col-5"><input type="number" id="highCost" class="form-control" placeholder="Est. Cost ‚Çπ"></div>
            </div>
            <label class="btn btn-outline-secondary w-100 mb-2 btn-sm">
                <i class="bi bi-images"></i> Select Photos
                <input type="file" id="highImg" class="form-control" accept="image/*" multiple hidden onchange="encodeImgs(this)">
            </label>
            <div id="imgPreview" class="preview-box mb-2" style="display:none;"></div>
            <div class="row g-2">
                <div class="col-6"><button class="btn btn-warning btn-sm w-100 fw-bold" onclick="saveMem('world')">POST WORLD</button></div>
                <div class="col-6"><button class="btn btn-primary btn-sm w-100 fw-bold" onclick="saveMem('trip')">POST TRIP</button></div>
            </div>
        </div>

        <div class="card p-3 bg-dark text-white mt-3">
            <h6 class="text-warning">üìä Settlement</h6>
            <div id="finalList" class="small mt-2"></div>
        </div>
    </div>
</div>

<script>
const firebaseConfig = {
      apiKey: "AIzaSyCp_ctBvgHAmqxpU9xDbxaufDftKulcJXk",
      authDomain: "akproject-176c7.firebaseapp.com",
      databaseURL: "https://akproject-176c7-default-rtdb.firebaseio.com",
      projectId: "akproject-176c7",
      storageBucket: "akproject-176c7.firebasestorage.app",
      messagingSenderId: "769234833598",
      appId: "1:769234833598:web:db90a08802c07d94810eef"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let user = null, tid = "", tripData = {}, tempImages = [];
let map, markers = {}, watchId = null;

window.onload = () => { 
    const saved = localStorage.getItem('yatra_user');
    if(saved) { user = JSON.parse(saved); showHome(); }
};

function hideAll() { ['authScreen','homeScreen','mainApp','profileScreen'].forEach(id => document.getElementById(id).style.display='none'); }
function showLogin() { hideAll(); document.getElementById('authScreen').style.display='flex'; document.getElementById('loginForm').style.display='block'; document.getElementById('regForm').style.display='none'; }
function showReg() { document.getElementById('loginForm').style.display='none'; document.getElementById('regForm').style.display='block'; }
function showHome() { hideAll(); document.getElementById('homeScreen').style.display='block'; loadTrips();

<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GHUMO PRO - Data Fixed</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        :root { --glass: rgba(255, 255, 255, 0.95); --text: #333; }
        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(135deg, #833ab4, #fd1d1d, #fcb045);
            background-attachment: fixed;
            min-height: 100vh; color: var(--text); padding-bottom: 30px; user-select: none;
        }

        .vibrant-card {
            background: var(--glass); backdrop-filter: blur(10px); border-radius: 20px;
            padding: 15px; margin-bottom: 15px; box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .app-header {
            background: rgba(255,255,255,0.3); backdrop-filter: blur(12px); padding: 15px 20px;
            position: sticky; top: 0; z-index: 1000; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.3); color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .btn-grad { border: none; border-radius: 50px; padding: 10px; font-weight: 700; color: white; width: 100%; transition: 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .btn-grad:active { transform: scale(0.96); }
        
        .bg-orange { background: linear-gradient(to right, #FF512F, #DD2476); }
        .bg-green { background: linear-gradient(to right, #11998e, #38ef7d); }
        .bg-blue { background: linear-gradient(to right, #2193b0, #6dd5ed); }
        .bg-dark { background: linear-gradient(to right, #232526, #414345); }
        .bg-purple { background: linear-gradient(to right, #8E2DE2, #4A00E0); }
        .bg-red { background: linear-gradient(to right, #cb2d3e, #ef473a); }

        .vib-input { border: 1px solid #ddd; background: #fff; padding: 12px; border-radius: 12px; width: 100%; margin-bottom: 10px; outline: none; }
        
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; position: relative; }
        .head-badge { background: gold; color: black; padding: 3px 8px; border-radius: 10px; font-weight: bold; border: 1px solid orange; box-shadow: 0 0 10px gold; }
        
        .custom-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-box { background: white; padding: 25px; border-radius: 25px; width: 90%; max-width: 350px; text-align: center; position: relative; max-height: 85vh; overflow-y: auto; }
        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #aaa; }

        .hidden { display: none !important; }
        .full-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #833ab4, #fd1d1d, #fcb045); }
        .feed-img { width: 100%; height: 250px; object-fit: cover; border-radius: 10px; margin-top: 5px; }
        .action-icon { cursor: pointer; margin-left: 10px; font-size: 1.1rem; }
        .profile-pic-preview { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid white; margin-bottom: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        
        .offer-btn { min-width: 90px; text-align: center; margin-right: 10px; cursor: pointer; }
        .offer-icon { font-size: 1.5rem; background: #fff; padding: 10px; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 5px; display: inline-block; }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>

<div id="estModal" class="custom-modal"><div class="modal-box"><span class="close-btn" onclick="closeModal('estModal')">√ó</span><h4 class="text-primary fw-bold">üìä Estimate Trip</h4><div class="text-start small fw-bold text-muted">Fuel/Travel</div><input type="number" id="eTravel" class="vib-input" placeholder="Total Travel Cost"><div class="text-start small fw-bold text-muted mt-2">Stay & Food</div><input type="number" id="eHotel" class="vib-input" placeholder="Hotel Cost"><input type="number" id="eOther" class="vib-input" placeholder="Food/Misc"><div class="text-start small fw-bold text-muted mt-2">Members</div><input type="number" id="ePpl" class="vib-input" placeholder="No. of People" value="1"><button class="btn-grad bg-blue mt-2" onclick="calcEst()">Save Estimate</button></div></div>

<div id="headSetupModal" class="custom-modal"><div class="modal-box"><span class="close-btn" onclick="closeModal('headSetupModal')">√ó</span><h5>üè¶ Head UPI Setup</h5><input type="text" id="headUPIInput" class="vib-input mt-3" placeholder="Enter UPI ID"><button class="btn-grad bg-blue" onclick="saveHeadUPI()">Save</button></div></div>

<div id="payHeadModal" class="custom-modal"><div class="modal-box"><span class="close-btn" onclick="closeModal('payHeadModal')">√ó</span><h5 class="text-primary">Pay to Head</h5><p id="hName" class="small text-muted">--</p><div id="hQr" class="my-2"></div><h3 class="mt-2">‚Çπ<span id="hAmt">0</span></h3><a id="hLink" class="btn-grad bg-green mb-2" href="#">Pay Now</a><button class="btn-grad bg-dark" onclick="confPay()">‚úÖ I Paid</button></div></div>

<div id="qrModal" class="custom-modal"><div class="modal-box"><span class="close-btn" onclick="closeModal('qrModal')">√ó</span><h5 class="text-success">Support Dev</h5><div id="dQr" class="my-2"></div><h3 class="mt-2">‚Çπ<span id="dAmt">0</span></h3><a id="dLink" class="btn-grad bg-dark" href="#">Pay via UPI</a></div></div>

<div id="aboutModal" class="custom-modal"><div class="modal-box"><span class="close-btn" onclick="closeModal('aboutModal')">√ó</span><h4>GHUMO PRO</h4><p class="small text-muted">Version 9.0 (Join Fixed)</p><hr><p class="small"><b>Dev:</b> <span id="devNameAbout">--</span></p></div></div>

<div id="authScreen" class="full-screen">
    <div class="vibrant-card text-center" style="width:340px; background:white;">
        <h1 class="fw-bold mb-4" style="color:#fd1d1d;">GHUMO</h1>
        
        <div id="loginForm">
            <input type="number" id="l_mobile" class="vib-input" placeholder="Mobile Number">
            <input type="password" id="l_pass" class="vib-input" placeholder="Password (XXXX)">
            <button class="btn-grad bg-orange mb-3" onclick="doLogin()">LOGIN</button>
            <div onclick="biometricLogin()" style="cursor:pointer;" class="mb-3 text-primary">
                <i class="bi bi-fingerprint fs-1"></i><br><small>Biometric Login</small>
            </div>
            <button class="btn btn-link text-muted" onclick="showReg()">Create New Account</button>
        </div>
        
        <div id="regForm" class="hidden text-start">
            <h5 class="text-center mb-3">Create Profile</h5>
            <div class="text-center">
                <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" id="regPreview" class="profile-pic-preview">
                <input type="file" id="r_pic" accept="image/*" class="d-none" onchange="previewRegImg(this)">
                <br><label for="r_pic" class="badge bg-secondary mb-2 cursor-pointer">Upload Photo (Optional)</label>
            </div>
            
            <input type="text" id="r_name" class="vib-input" placeholder="Full Name (Required)">
            <input type="number" id="r_mobile" class="vib-input" placeholder="Mobile (Required)">
            <input type="password" id="r_pass" class="vib-input" placeholder="Password (Required)">
            
            <input type="text" id="r_address" class="vib-input" placeholder="Address (Optional)">
            <select id="r_gender" class="vib-input text-muted">
                <option value="">Select Gender (Optional)</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
            </select>
            
            <button class="btn-grad bg-green mb-2" onclick="doRegister()">REGISTER</button>
            <button class="btn btn-link text-muted w-100" onclick="showLogin()">Back to Login</button>
        </div>
        
        <p id="statusMsg" class="mt-3 small text-danger"></p>
    </div>
</div>

<div id="homeScreen" class="hidden">
    <div class="app-header">
        <div class="d-flex align-items-center">
            <img src="" id="userHeaderImg" style="width:35px; height:35px; border-radius:50%; margin-right:10px; background:#ddd;">
            <div class="fw-bold lh-1">GHUMO<br><small style="font-weight:normal; font-size:0.7rem;" id="uName">User</small></div>
        </div>
        <i class="bi bi-gear-fill fs-4" style="cursor:pointer;" onclick="openSettings()"></i>
    </div>
    <div class="container py-3">
        <div class="row g-3 mb-3">
            <div class="col-6"><button class="btn-grad bg-blue" onclick="createTrip()"><i class="bi bi-plus-circle"></i> Create</button></div>
            <div class="col-6"><button class="btn-grad bg-dark" onclick="joinTrip()"><i class="bi bi-rocket-takeoff"></i> Join</button></div>
        </div>
        
        <div class="vibrant-card p-2">
            <h6 class="fw-bold ps-2 mb-3">üî• TRAVEL OFFERS</h6>
            <div class="d-flex gap-1 overflow-auto pb-2">
                <div class="offer-btn" onclick="win('https://booking.com')"><div class="offer-icon">üè®</div><br><small>Hotel</small></div>
                <div class="offer-btn" onclick="win('https://hotels.com')"><div class="offer-icon">üõå</div><br><small>Motel</small></div>
                <div class="offer-btn" onclick="win('https://makemytrip.com')"><div class="offer-icon">‚úàÔ∏è</div><br><small>Flight</small></div>
                <div class="offer-btn" onclick="win('https://irctc.co.in')"><div class="offer-icon">üöÜ</div><br><small>Train</small></div>
                <div class="offer-btn" onclick="win('https://redbus.in')"><div class="offer-icon">üöå</div><br><small>Bus</small></div>
                <div class="offer-btn" onclick="win('https://zoomcar.com')"><div class="offer-icon">üöó</div><br><small>Rent Car</small></div>
                <div class="offer-btn" onclick="win('https://www.royalbrothers.com/')"><div class="offer-icon">üõµ</div><br><small>2-Wheel</small></div>
                <div class="offer-btn" onclick="win('https://amazon.in')"><div class="offer-icon">üéí</div><br><small>Accessory</small></div>
            </div>
        </div>

        <h6 class="text-white fw-bold ps-2">MY TRIPS</h6>
        <div id="userTripList"><p class="text-center text-white small">Loading...</p></div>
        
        <br><button class="btn-grad bg-white text-danger mb-4" onclick="donate()">‚ù§Ô∏è Support Dev</button>
        <div id="globalFeed"></div>
    </div>
</div>

<div id="mainApp" class="hidden">
    <div class="app-header">
        <i class="bi bi-arrow-left fs-3" style="cursor:pointer;" onclick="goBackLogic()"></i>
        <div class="text-center">
            <span class="fw-bold" id="tName">Trip</span> 
            <i class="bi bi-pencil-square text-white ms-1" style="cursor:pointer; font-size:0.9rem;" onclick="editTripName()"></i>
            <br><small id="tCode" style="opacity:0.8"></small>
        </div>
        <div></div>
    </div>

    <div class="container py-3">
        <div class="row g-2 mb-2">
            <div class="col-6">
                <div class="vibrant-card text-center py-2" style="background:rgba(255,255,255,0.9); margin-bottom:0;">
                    <small class="text-muted fw-bold">ESTIMATE</small>
                    <h5 class="fw-bold text-dark m-0">‚Çπ<span id="dashEst">0</span></h5>
                </div>
            </div>
            <div class="col-6">
                <div class="vibrant-card text-center py-2" style="background:rgba(255,255,255,0.9); margin-bottom:0;">
                    <small class="text-muted fw-bold">NET EXPENSE</small>
                    <h5 class="fw-bold text-danger m-0">‚Çπ<span id="netExp">0</span></h5>
                </div>
            </div>
        </div>

        <div class="vibrant-card text-center py-2">
            <div class="row">
                <div class="col-6 border-end"><small>BALANCE</small><br><h3 class="fw-bold text-primary">‚Çπ<span id="bal">0</span></h3></div>
                <div class="col-6"><small>SPENT/HEAD</small><br><h3 class="fw-bold text-danger">‚Çπ<span id="ph">0</span></h3></div>
            </div>
        </div>

        <div id="headArea" class="mb-3"></div>

        <div class="row g-2 mb-3">
            <div class="col-6"><button class="btn-grad bg-orange small" onclick="toggle('formExp')">üí∏ Expense</button></div>
            <div class="col-6"><button class="btn-grad bg-green small" onclick="toggle('formDep')">üí∞ Deposit</button></div>
            <div class="col-6"><button class="btn-grad bg-blue small" onclick="document.getElementById('estModal').style.display='flex'">üìä Calculator</button></div>
            <div class="col-6"><button class="btn-grad bg-dark small" onclick="toggle('formMem')">üì∏ Post</button></div>
        </div>

        <div id="formExp" class="vibrant-card hidden">
            <h6 class="text-danger fw-bold">Add Expense</h6>
            <select id="exCat" class="vib-input">
                <option value="Food">Food</option>
                <option value="Hotel">Hotel</option>
                <option value="Fare">Fare/Travel</option>
                <option value="Petrol">Petrol/Fuel</option>
                <option value="Toll">Toll</option>
                <option value="Other">Other</option>
            </select>
            <input type="text" id="exR" class="vib-input" placeholder="Item Name (Optional)">
            <input type="number" id="exA" class="vib-input" placeholder="Amount ‚Çπ">
            <button class="btn-grad bg-orange" onclick="addExp()">Add</button>
        </div>
        <div id="formDep" class="vibrant-card hidden">
            <h6 class="text-success fw-bold">Deposit</h6>
            <select id="dpM" class="vib-input"></select>
            <input type="number" id="dpA" class="vib-input" placeholder="Amount ‚Çπ">
            <button class="btn-grad bg-green" onclick="addDep()">Deposit</button>
        </div>
        <div id="formMem" class="vibrant-card hidden">
            <h6 class="text-dark fw-bold">Create Post</h6>
            <input type="text" id="mTxt" class="vib-input" placeholder="Caption...">
            <input type="text" id="mLoc" class="vib-input" placeholder="üìç Location">
            <input type="file" id="mImg" class="vib-input" multiple onchange="encImg(this)">
            <div class="d-flex gap-2 mt-2">
                <button class="btn-grad bg-dark" onclick="saveMem('trip')">To Trip</button>
                <button class="btn-grad bg-purple" onclick="saveMem('world')">To World</button>
            </div>
        </div>

        <div class="vibrant-card border-info" style="border-left:5px solid #0dcaf0;">
            <h6 class="text-info fw-bold">üöå Route Planner</h6>
            <div class="d-flex gap-2">
                <select id="trMode" class="vib-input w-50"><option>Bus</option><option>Train</option><option>Flight</option><option>Taxi</option></select>
                <input type="number" id="trFare" class="vib-input w-50" placeholder="Fare ‚Çπ">
            </div>
            <div class="d-flex gap-2">
                <input type="text" id="trFrom" class="vib-input" placeholder="From">
                <input type="text" id="trTo" class="vib-input" placeholder="To">
            </div>
            <button class="btn-grad bg-blue mb-2" onclick="addTrans()">Add Route</button>
            <button class="btn-grad bg-green" onclick="shareRoute()">üì≤ Share Itinerary</button>
        </div>

        <div class="vibrant-card">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="text-muted small fw-bold m-0">RECENT ACTIVITY</h6>
                <select id="filterCat" class="vib-input py-1 px-2 w-auto mb-0" style="font-size:0.8rem;" onchange="renderUI()">
                    <option value="All">All</option>
                    <option value="Food">Food</option>
                    <option value="Hotel">Hotel</option>
                    <option value="Fare">Fare</option>
                    <option value="Petrol">Petrol</option>
                    <option value="Toll">Toll</option>
                </select>
            </div>
            <div id="actList" style="max-height:250px; overflow-y:auto;"></div>
        </div>

        <div class="vibrant-card">
            <h6 class="fw-bold">Members <small class="text-muted fw-normal">(Tap name to make Head)</small></h6>
            <div id="memList" class="d-flex flex-wrap gap-2"></div>
        </div>

        <button class="btn-grad bg-red mt-3 mb-4" onclick="exitTripLogic()">üö™ Exit Trip</button>

        <h6 class="text-white fw-bold mt-4 ps-2">MEMORIES</h6>
        <div id="feedArea"></div>
        <div class="vibrant-card mt-3"><h6 class="text-primary">Final Settlement</h6><div id="finalList" class="small"></div></div>
    </div>
</div>

<div id="settingsScreen" class="hidden full-screen" style="background:white; z-index:3000; overflow-y:auto; display:block;">
    <div class="app-header"><i class="bi bi-arrow-left fs-3" style="cursor:pointer;" onclick="showHome()"></i> Settings <div></div></div>
    <div class="container text-center py-5">
        <img src="" id="setProfImg" style="width:100px; height:100px; border-radius:50%; margin-bottom:10px; border:2px solid #333;">
        <h4 id="setName">--</h4>
        <div class="vibrant-card text-start">
            <small>Name</small><input type="text" id="upN" class="vib-input">
            <small>Address</small><input type="text" id="upAdd" class="vib-input">
            <small>Gender</small><input type="text" id="upGen" class="vib-input" readonly>
            <small>Password</small><input type="password" id="upP" class="vib-input">
            <button class="btn-grad bg-blue mt-2" onclick="updProf()">Update Profile</button>
        </div>
        <button class="btn-grad bg-white text-dark mb-3 shadow-sm border" onclick="document.getElementById('aboutModal').style.display='flex'">‚ÑπÔ∏è About App</button>
        <button class="btn-grad bg-orange" onclick="doLogout()">Log Out</button>
    </div>
</div>

<script>
// CONFIG
const DEV_NAME="YOUR NAME", UPI_ID="YOUR_UPI";
const firebaseConfig = { apiKey: "AIzaSyCp_ctBvgHAmqxpU9xDbxaufDftKulcJXk", authDomain: "akproject-176c7.firebaseapp.com", databaseURL: "https://akproject-176c7-default-rtdb.firebaseio.com", projectId: "akproject-176c7", storageBucket: "akproject-176c7.firebasestorage.app", messagingSenderId: "769234833598", appId: "1:769234833598:web:db90a08802c07d94810eef" };
firebase.initializeApp(firebaseConfig); const db=firebase.database();
let user=null, tid="", trip={}, imgs=[], hPay=0, tripRef=null, regImgBase64="";
function safe(d){return d?(Array.isArray(d)?d:Object.values(d)):[];}
function closeModal(id){document.getElementById(id).style.display='none';}
function toggle(id){const e=document.getElementById(id);e.classList.toggle('hidden');}
function win(url){ window.open(url, '_blank'); }

// AUTH & NAV
window.onload=()=>{
    document.querySelectorAll('#devNameAbout').forEach(e=>e.innerText=DEV_NAME);
    const s=localStorage.getItem('yatra_user');
    if(s){ user=JSON.parse(s); updateUserDisplay(); showHome(); } 
    else { hideAll(); document.getElementById('authScreen').classList.remove('hidden'); }
};
function updateUserDisplay(){
    document.getElementById('uName').innerText=user.name;
    document.getElementById('userHeaderImg').src = user.photo || "https://cdn-icons-png.flaticon.com/512/3135/3135715.png";
}
function hideAll(){ ['authScreen','homeScreen','mainApp','settingsScreen'].forEach(i=>document.getElementById(i).classList.add('hidden')); }
function showHome(){ hideAll(); document.getElementById('homeScreen').classList.remove('hidden'); loadTrips(); loadWorld(); }
function openSettings(){ 
    hideAll(); document.getElementById('settingsScreen').classList.remove('hidden'); 
    document.getElementById('setName').innerText=user.name; 
    document.getElementById('upN').value=user.name; 
    document.getElementById('upAdd').value=user.address||""; 
    document.getElementById('upGen').value=user.gender||""; 
    document.getElementById('upP').value=user.password;
    document.getElementById('setProfImg').src = user.photo || "https://cdn-icons-png.flaticon.com/512/3135/3135715.png";
}

function doLogin(){
    const m=document.getElementById('l_mobile').value,p=document.getElementById('l_pass').value; 
    if(!m||!p) { setStatus("Enter Mobile & Password"); return; }
    setStatus("Checking...");
    db.ref('users/'+m).once('value', s=>{
        if(s.exists()){
            if(s.val().password == p){ 
                user=s.val(); localStorage.setItem('yatra_user',JSON.stringify(user)); updateUserDisplay(); setStatus(""); showHome(); 
            } else setStatus("Wrong Password!");
        } else setStatus("Number not found. Register first.");
    }).catch(e => setStatus("Network Error: " + e.message));
}

function biometricLogin() {
    const m=document.getElementById('l_mobile').value;
    if(!m) { alert("Enter Mobile Number first"); return; }
    let touch = confirm("üëÜ Verify fingerprint to login.");
    if(touch) {
        db.ref('users/'+m).once('value', s=>{
            if(s.exists()) {
                user=s.val(); localStorage.setItem('yatra_user',JSON.stringify(user)); updateUserDisplay(); showHome();
            } else alert("User not found!");
        });
    }
}

function previewRegImg(input) {
    if(input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image(); img.src = e.target.result;
            img.onload = () => {
                const c = document.createElement('canvas'); const ctx = c.getContext('2d');
                const w = 150; const sc = w/img.width; 
                c.width=w; c.height=img.height*sc;
                ctx.drawImage(img,0,0,c.width,c.height);
                regImgBase64 = c.toDataURL('image/jpeg', 0.7);
                document.getElementById('regPreview').src = regImgBase64;
            }
        }
        reader.readAsDataURL(input.files[0]);
    }
}

function doRegister(){
    const n=document.getElementById('r_name').value,m=document.getElementById('r_mobile').value,p=document.getElementById('r_pass').value;
    const add=document.getElementById('r_address').value, gen=document.getElementById('r_gender').value;
    if(!n||!m||!p) { setStatus("Name, Mobile & Pass Required"); return; }
    
    setStatus("Creating Account...");
    db.ref('users/'+m).set({name:n, mobile:m, password:p, address:add, gender:gen, photo:regImgBase64, history:[]})
    .then(()=>{
        user={name:n, mobile:m, password:p, address:add, gender:gen, photo:regImgBase64};
        localStorage.setItem('yatra_user',JSON.stringify(user)); updateUserDisplay(); showHome();
    })
    .catch(e => setStatus("Error: " + e.message));
}

function setStatus(msg) { document.getElementById('statusMsg').innerText = msg; }
function showReg(){ toggle('loginForm'); toggle('regForm'); setStatus(""); }
function showLogin(){ toggle('loginForm'); toggle('regForm'); setStatus(""); }
function doLogout(){ localStorage.removeItem('yatra_user'); location.reload(); }
function updProf(){ const n=document.getElementById('upN').value, p=document.getElementById('upP').value, a=document.getElementById('upAdd').value; if(n) db.ref('users/'+user.mobile).update({name:n,password:p,address:a}).then(()=>{user.name=n;user.address=a;user.password=p;localStorage.setItem('yatra_user',JSON.stringify(user));alert("Updated!");showHome();}); }

// TRIP
function createTrip(){const n=prompt("Name:");if(n){const id="T"+Math.floor(10000+Math.random()*90000);db.ref('trips/'+id).set({name:n,members:[user.name]}).then(()=>{addHist(id);enterTrip(id);});}}
function joinTrip(){const i=prompt("Code:");if(i)db.ref('trips/'+i.toUpperCase()).once('value',s=>{if(s.exists()){addHist(i.toUpperCase());joinTripDataFix(i.toUpperCase());}else alert("Invalid");});}
function addHist(id){db.ref('users/'+user.mobile+'/history').once('value',s=>{let h=safe(s.val());if(!h.includes(id)){h.push(id);db.ref('users/'+user.mobile+'/history').set(h);}});}
function loadTrips(){db.ref('users/'+user.mobile+'/history').on('value',async s=>{const l=document.getElementById('userTripList');l.innerHTML="";const c=safe(s.val());if(!c.length){l.innerHTML="<p class='text-center text-white small'>No trips.</p>";return;}for(const i of c){const sp=await db.ref('trips/'+i).once('value');if(sp.exists())l.innerHTML+=`<div class="vibrant-card d-flex justify-content-between p-2 mb-2" onclick="enterTrip('${i}')"><b>${sp.val().name}</b><small>${i}</small></div>`;}});}

// FIXED JOIN LOGIC
function joinTripDataFix(id) {
    db.ref('trips/'+id).once('value', s => {
        let t = s.val();
        if(t) {
            let m = safe(t.members);
            if(!m.includes(user.name)) { m.push(user.name); db.ref('trips/'+id+'/members').set(m); }
            enterTrip(id);
        }
    });
}

// BACK / EXIT LOGIC
function goBackLogic() { showHome(); }
function exitTripLogic() {
    if(confirm("‚ö† DO YOU WANT TO EXIT THIS TRIP?")) {
        if(trip.head === user.name) { alert("Assign new Head first!"); return; }
        if(tripRef) tripRef.off();
        db.ref('trips/'+tid+'/members').set(safe(trip.members).filter(m => m !== user.name));
        db.ref('users/'+user.mobile+'/history').once('value', s => { db.ref('users/'+user.mobile+'/history').set(safe(s.val()).filter(x => x !== tid)).then(() => { alert("Exited!"); showHome(); }); });
    }
}

function enterTrip(id){
    tid=id; hideAll(); document.getElementById('mainApp').classList.remove('hidden');
    if(tripRef) tripRef.off(); tripRef = db.ref('trips/'+tid);
    tripRef.on('value',s=>{ trip=s.val(); if(!trip) return; renderUI(); });
}

function renderUI(){
    document.getElementById('tName').innerText=trip.name; document.getElementById('tCode').innerText=tid;
    const isHead=(user.name.toLowerCase()===(trip.head||"").toLowerCase());
    const hDiv=document.getElementById('headArea'); hDiv.innerHTML=isHead?`<button class="btn-grad bg-blue" onclick="document.getElementById('headSetupModal').style.display='flex'">üè¶ Setup UPI</button>`:(trip.head?`<button class="btn-grad bg-green" onclick="payH()">üí∏ Pay Head</button>`:"");

    document.getElementById('dashEst').innerText = trip.estBudget || 0;
    
    const filter = document.getElementById('filterCat').value;
    const l=document.getElementById('actList'); l.innerHTML="";
    let totalExp = 0;

    // Deposits
    safe(trip.deposits).slice().reverse().forEach(d=>{
        if(filter === 'All') {
            const del=(d.who===user.name||isHead)?`<i class="bi bi-trash text-danger action-icon" onclick="delD(${d.t})"></i>`:"";
            l.innerHTML+=`<div class="list-item" style="border-left:4px solid #2ecc71"><div><small>${d.who}</small><br><b>+‚Çπ${d.amt}</b></div>${del}</div>`;
        }
    });
    // Expenses
    safe(trip.expenses).slice().reverse().forEach(e=>{
        totalExp += parseFloat(e.a);
        if(filter === 'All' || filter === e.cat) {
            const del=(isHead||e.who===user.name)?`<div class="d-flex gap-2"><i class="bi bi-pencil text-primary action-icon" onclick="edE(${e.t},'${e.r}','${e.a}')"></i><i class="bi bi-trash text-danger action-icon" onclick="delE(${e.t})"></i></div>`:"";
            const date = e.date ? new Date(e.date).toLocaleString() : "";
            const badge = e.cat ? `<span class="badge bg-secondary" style="font-size:0.6rem;">${e.cat}</span>` : "";
            l.innerHTML+=`<div class="list-item" style="border-left:4px solid #e74c3c"><div><small>${e.r || e.cat}</small> ${badge}<br><small style="font-size:0.7rem;">${date}</small><br><b>-‚Çπ${e.a}</b></div>${del}</div>`;
        }
    });

    document.getElementById('netExp').innerText = totalExp;

    const ml=document.getElementById('memList'); ml.innerHTML=""; const sl=document.getElementById('dpM'); sl.innerHTML="";
    if(trip.members) trip.members.forEach(m=>{
        const isH=(trip.head&&m.toLowerCase()===trip.head.toLowerCase());
        ml.innerHTML+=`<span class="badge ${isH?'head-badge':'bg-white text-dark border'} p-2 me-1" onclick="mkHead('${m}')">${isH?'üëë':''} ${m}</span>`;
        sl.innerHTML+=`<option value="${m}">${m}</option>`;
    });

    const tin=safe(trip.deposits).reduce((s,x)=>s+x.amt,0);
    document.getElementById('bal').innerText=tin-totalExp; 
    document.getElementById('ph').innerText=trip.members ? Math.round(totalExp/trip.members.length) : 0;
    
    // Settlement with Total Deposit Column
    const fl=document.getElementById('finalList'); fl.innerHTML=`<div class="d-flex justify-content-between small fw-bold border-bottom"><span>Member</span><span>Deposited</span><span>Settlement</span></div>`; 
    if(trip.members) {
        let avg=Math.round(totalExp/trip.members.length), pd={};
        trip.members.forEach(m=>pd[m]=0); safe(trip.deposits).forEach(d=>{if(pd[d.who]!==undefined)pd[d.who]+=d.amt;});
        trip.members.forEach(m=>{
            let b=avg-pd[m]; 
            let col = b>0 ? 'text-danger' : 'text-success';
            let txt = b>0 ? 'Pay: '+b : 'Get: '+Math.abs(b);
            fl.innerHTML+=`<div class="d-flex justify-content-between border-bottom py-1"><span>${m}</span><span>‚Çπ${pd[m]}</span><span class="${col}">${txt}</span></div>`;
        });
    }
    renderFeed();
}

function editTripName() {
    const n = prompt("Enter new Trip Name:", trip.name);
    if(n) db.ref('trips/'+tid+'/name').set(n);
}

function addExp(){
    const cat = document.getElementById('exCat').value;
    const r=document.getElementById('exR').value || cat; 
    const a=parseFloat(document.getElementById('exA').value);
    if(a){db.ref('trips/'+tid+'/expenses').set([...safe(trip.expenses),{r,a,cat,who:user.name,date:Date.now(),t:Date.now()}]);toggle('formExp');}
}
function addDep(){const w=document.getElementById('dpM').value,a=parseFloat(document.getElementById('dpA').value);if(w&&a){db.ref('trips/'+tid+'/deposits').set([...safe(trip.deposits),{who:w,amt:a,t:Date.now()}]);toggle('formDep');}}
function delE(t){if(confirm("Delete?"))db.ref('trips/'+tid+'/expenses').set(safe(trip.expenses).filter(x=>x.t!==t));}
function delD(t){if(confirm("Delete Deposit?"))db.ref('trips/'+tid+'/deposits').set(safe(trip.deposits).filter(x=>x.t!==t));}
function edE(t,or,oa){const nr=prompt("Item:",or),na=prompt("Amount:",oa);if(nr&&na)db.ref('trips/'+tid+'/expenses').set(safe(trip.expenses).map(x=>x.t===t?{...x,r:nr,a:parseFloat(na)}:x));}
function mkHead(n){if(confirm("Make "+n+" Head?"))db.ref('trips/'+tid+'/head').set(n);}
function saveHeadUPI(){const u=document.getElementById('headUPIInput').value;if(u){db.ref('trips/'+tid+'/headUPI').set(u);closeModal('headSetupModal');}}
function payH(){const a=prompt("Amount:");if(a){if(!trip.headUPI){alert("No UPI");return;}hPay=parseFloat(a);const l=`upi://pay?pa=${trip.headUPI}&pn=${trip.head}&am=${a}&cu=INR`;document.getElementById('payHeadModal').style.display='flex';document.getElementById('hName').innerText="To: "+trip.head;document.getElementById('hAmt').innerText=a;document.getElementById('hLink').href=l;document.getElementById('hQr').innerHTML=`<img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(l)}">`;}}
function confPay(){db.ref('trips/'+tid+'/deposits').set([...safe(trip.deposits),{who:user.name,amt:hPay,t:Date.now()}]);closeModal('payHeadModal');alert("Added!");}
function addTrans(){const m=document.getElementById('trMode').value,f=document.getElementById('trFrom').value,t=document.getElementById('trTo').value,a=parseFloat(document.getElementById('trFare').value);if(f&&t&&a){db.ref('trips/'+tid+'/expenses').set([...safe(trip.expenses),{r:`${m}: ${f} ‚ûî ${t}`,a,cat:'Fare',who:user.name,date:Date.now(),t:Date.now()}]);alert("Added!");}}
function shareRoute(){const r=safe(trip.expenses).filter(e=>e.r.includes("‚ûî"));if(!r.length)return alert("No routes");let m=`üöÄ *TRIP PLAN: ${trip.name}*\n\n`,t=0;r.forEach((x,i)=>{m+=`‚úÖ ${x.r} (‚Çπ${x.a})\n`;t+=x.a;});m+=`\nüí∞ Total: ‚Çπ${t}`;window.open(`https://wa.me/?text=${encodeURIComponent(m)}`,'_blank');}
function calcEst(){const t=parseFloat(document.getElementById('eTravel').value)||0;const h=parseFloat(document.getElementById('eHotel').value)||0;const o=parseFloat(document.getElementById('eOther').value)||0;const p=parseFloat(document.getElementById('ePpl').value)||1;const tot = t + h + o;const ph = Math.round(tot / p);db.ref('trips/'+tid).update({estBudget: tot, estPerHead: ph});alert("Saved!");closeModal('estModal');}
function editDashEst() { const newTot = prompt("Enter New Total Budget:", trip.estBudget || 0); if(newTot) { const tot = parseFloat(newTot); const memCount = trip.members ? trip.members.length : 1; const ph = Math.round(tot / memCount); db.ref('trips/'+tid).update({estBudget: tot, estPerHead: ph}); } }
function encImg(i){imgs=[];if(i.files)Array.from(i.files).forEach(f=>{const r=new FileReader();r.onload=e=>{const c=document.createElement('canvas'),x=c.getContext('2d'),w=500,i=new Image();i.src=e.target.result;i.onload=()=>{const sc=w/i.width;c.width=w;c.height=i.height*sc;x.drawImage(i,0,0,w,c.height);imgs.push(c.toDataURL('image/jpeg',0.6));}};r.readAsDataURL(f);});}
function saveMem(type){const t=document.getElementById('mTxt').value, l=document.getElementById('mLoc').value; if(!t)return; const p={who:user.name,txt:t,loc:l,imgs:imgs,t:Date.now()}; if(type==='trip') db.ref('trips/'+tid+'/highlights').set([...safe(trip.highlights),p]); else db.ref('global_public_feed').push(p); alert("Posted!"); toggle('formMem'); imgs=[];}
function renderFeed(){const d=document.getElementById('feedArea'); d.innerHTML=""; safe(trip.highlights).reverse().forEach(h=>{let im=""; if(h.imgs)h.imgs.forEach(i=>im+=`<img src="${i}" class="feed-img">`); const del = (h.who===user.name || user.name===trip.head) ? `<i class="bi bi-trash text-danger position-absolute top-0 end-0 m-2 bg-white p-1 rounded action-icon" onclick="delPost('${h.t}')"></i>` : ""; d.innerHTML+=`<div class="vibrant-card p-0 overflow-hidden position-relative">${del}<div class="p-3"><b>${h.who}</b> <small class="text-muted">at ${h.loc||"Unknown"}</small><p>${h.txt}</p></div>${im}</div>`;});}
function delPost(t){if(confirm("Delete?"))db.ref('trips/'+tid+'/highlights').set(safe(trip.highlights).filter(h=>h.t!=t));}
function loadWorld(){db.ref('global_public_feed').limitToLast(10).on('value',s=>{const d=document.getElementById('globalFeed');d.innerHTML=""; const data = s.val() || {}; Object.keys(data).reverse().forEach(key=>{const k = data[key]; let im="";if(k.imgs)k.imgs.forEach(i=>im+=`<img src="${i}" class="feed-img">`); let ctrls = (k.who === user.name) ? `<div class="d-flex justify-content-end gap-2 p-2"><button class="btn btn-sm btn-light border" onclick="editW('${key}','${k.txt}')">‚úèÔ∏è Edit</button><button class="btn btn-sm btn-danger" onclick="delW('${key}')">üóëÔ∏è Delete</button></div>` : ""; d.innerHTML+=`<div class="vibrant-card p-0 overflow-hidden bg-white"><div class="p-3"><b>${k.who}</b> <small class="text-muted">at ${k.loc||"Unknown"}</small><p>${k.txt}</p></div>${im}${ctrls}</div>`;});});}
function delW(k){ if(confirm("Delete?")) db.ref('global_public_feed/'+k).remove(); }
function editW(k, old){ const n = prompt("Update:", old); if(n) db.ref('global_public_feed/'+k).update({txt:n}); }
function donate(){ const a=prompt("Amount:"); if(a){ const l=`upi://pay?pa=${UPI_ID}&pn=${DEV_NAME}&am=${a}&cu=INR`; document.getElementById('qrModal').style.display='flex'; document.getElementById('dAmt').innerText=a; document.getElementById('dLink').href=l; document.getElementById('dQr').innerHTML=`<img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(l)}">`; } }
</script>
</body>
</html>

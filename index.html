<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GHUMO PRO - Soft Future</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #e0e5ec;
            --text: #4d4d4d;
            --shadow-light: #ffffff;
            --shadow-dark: #a3b1c6;
            --primary: #6d5dfc;
            --danger: #e53935;
            --success: #00b894;
        }

        body { 
            background-color: var(--bg); 
            color: var(--text);
            font-family: 'Nunito', sans-serif;
            padding-bottom: 30px;
            user-select: none;
        }

        /* --- NEUMORPHISM UTILS --- */
        .neu-card {
            background: var(--bg);
            border-radius: 20px;
            box-shadow: 9px 9px 16px rgba(163,177,198,0.6), -9px -9px 16px rgba(255,255,255, 0.5);
            padding: 20px;
            margin-bottom: 20px;
            border: none;
        }

        .neu-btn {
            background: var(--bg);
            color: var(--text);
            border: none;
            border-radius: 50px;
            padding: 12px 20px;
            font-weight: 700;
            box-shadow: 6px 6px 10px 0 rgba(163,177,198, 0.7), -6px -6px 10px 0 rgba(255,255,255, 0.8);
            transition: all 0.2s ease;
            width: 100%;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .neu-btn:active {
            box-shadow: inset 4px 4px 8px rgba(163,177,198, 0.7), inset -4px -4px 8px rgba(255,255,255, 0.8);
            transform: translateY(2px);
        }
        .neu-btn-primary { color: var(--primary); }
        .neu-btn-danger { color: var(--danger); }
        .neu-btn-success { color: var(--success); }

        .neu-input {
            background: var(--bg);
            border: none;
            border-radius: 15px;
            padding: 15px;
            width: 100%;
            box-shadow: inset 6px 6px 10px 0 rgba(163,177,198, 0.7), inset -6px -6px 10px 0 rgba(255,255,255, 0.8);
            color: var(--text);
            outline: none;
            margin-bottom: 15px;
        }
        .neu-input::placeholder { color: #a0a0a0; }

        /* HEADER */
        .app-header {
            background: var(--bg);
            padding: 20px;
            position: sticky; top: 0; z-index: 1000;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 5px 5px 10px rgba(163,177,198,0.6);
            border-radius: 0 0 25px 25px;
            margin-bottom: 20px;
        }
        .logo-text { font-weight: 800; font-size: 1.4rem; color: var(--text); letter-spacing: 1px; }

        /* UTILITIES */
        .full-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--bg); 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            z-index: 9999;
        }
        .toggle-form { display: none; margin-top: 15px; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(-10px);} to{opacity:1;transform:translateY(0);} }

        /* LIST ITEMS */
        .list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px;
            border-radius: 15px;
            margin-bottom: 10px;
            box-shadow: inset 3px 3px 6px rgba(163,177,198,0.4), inset -3px -3px 6px rgba(255,255,255,0.5);
        }
        .list-item-green { border-left: 5px solid var(--success); }
        .list-item-red { border-left: 5px solid var(--danger); }

        /* HEAD BADGE */
        .head-badge {
            color: #f39c12 !important;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: 2px solid #f39c12;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
        }

        /* MODALS */
        .custom-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(224, 229, 236, 0.9); z-index: 2000;
            align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        .modal-box {
            background: var(--bg); padding: 30px; border-radius: 30px; width: 85%; max-width: 350px;
            text-align: center;
            box-shadow: 20px 20px 60px #bebebe, -20px -20px 60px #ffffff;
            position: relative;
        }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; color: var(--danger); }

        /* STATS */
        .stat-text { font-size: 2rem; font-weight: 800; }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>

<div id="qrModal" class="custom-modal"><div class="modal-box"><span class="close-btn" onclick="closeModal('qrModal')">√ó</span><h5 class="text-success fw-bold">Support Dev</h5><div id="qrImage" class="my-3"></div><h3 class="mt-2">‚Çπ<span id="qrAmount">0</span></h3><a id="payLink" href="#" class="neu-btn neu-btn-primary mt-3">Open UPI App</a></div></div>

<div id="payHeadModal" class="custom-modal"><div class="modal-box"><span class="close-btn" onclick="closeModal('payHeadModal')">√ó</span><h5 class="text-primary fw-bold">Pay to Head</h5><p id="headNameDisplay" class="small mt-2">--</p><div id="headQrImage" class="my-3"></div><h3 class="mt-2">‚Çπ<span id="headPayAmt">0</span></h3><a id="headPayLink" href="#" class="neu-btn neu-btn-success mb-3">Pay Now</a><button class="neu-btn" onclick="confirmHeadPayment()">‚úÖ Paid</button></div></div>

<div id="headSetupModal" class="custom-modal"><div class="modal-box"><span class="close-btn" onclick="closeModal('headSetupModal')">√ó</span><h5>Setup Collection</h5><input type="text" id="headUPIInput" class="neu-input mt-3" placeholder="Enter UPI ID"><button class="neu-btn neu-btn-primary" onclick="saveHeadUPI()">Save</button></div></div>

<div id="aboutModal" class="custom-modal"><div class="modal-box"><span class="close-btn" onclick="closeModal('aboutModal')">√ó</span><h4>GHUMO PRO</h4><p class="small">Soft Future Edition</p><hr><p class="small"><b>Dev:</b> <span id="devNameAbout">--</span></p></div></div>

<div id="authScreen" class="full-screen">
    <div style="width: 300px; text-align: center;">
        <h1 class="logo-text mb-4" style="font-size: 2.5rem; color: var(--primary);">GHUMO</h1>
        
        <div id="loginForm">
            <input type="number" id="l_mobile" class="neu-input" placeholder="Mobile Number">
            <input type="password" id="l_pass" class="neu-input" placeholder="Password">
            <button class="neu-btn neu-btn-primary mb-3" onclick="doLogin()">LOGIN</button>
            <button class="neu-btn" onclick="showReg()">Create Account</button>
        </div>
        
        <div id="regForm" style="display:none;">
            <input type="text" id="r_name" class="neu-input" placeholder="Full Name">
            <input type="number" id="r_mobile" class="neu-input" placeholder="Mobile">
            <input type="text" id="r_address" class="neu-input" placeholder="Address">
            <input type="password" id="r_pass" class="neu-input" placeholder="Password">
            <button class="neu-btn neu-btn-success mb-3" onclick="doRegister()">REGISTER</button>
            <button class="neu-btn" onclick="showLogin()">Back</button>
        </div>
        <p class="mt-5 small text-muted">Version 3.0 ‚Ä¢ Soft UI</p>
    </div>
</div>

<div id="homeScreen" style="display:none;">
    <div class="app-header">
        <div class="logo-text">GHUMO <small style="font-size:0.8rem; opacity:0.6;">| <span id="headerUserName">User</span></small></div>
        <i class="bi bi-gear-fill fs-4" style="color:var(--text); cursor:pointer;" onclick="openSettings()"></i>
    </div>

    <div class="container">
        <div class="row g-3 mb-4">
            <div class="col-6"><button class="neu-btn neu-btn-primary" style="height:100px; flex-direction:column;" onclick="createTrip()"><i class="bi bi-plus-circle fs-1"></i>Create</button></div>
            <div class="col-6"><button class="neu-btn" style="height:100px; flex-direction:column;" onclick="joinTrip()"><i class="bi bi-rocket-takeoff fs-1"></i>Join</button></div>
        </div>

        <div class="neu-card">
            <h6 class="fw-bold mb-3"><i class="bi bi-fire text-warning"></i> OFFERS</h6>
            <div class="d-flex gap-3" style="overflow-x:auto;">
                <button class="neu-btn" style="min-width:100px;" onclick="window.open('https://booking.com')">üè® Hotel</button>
                <button class="neu-btn" style="min-width:100px;" onclick="window.open('https://makemytrip.com')">‚úàÔ∏è Flight</button>
                <button class="neu-btn" style="min-width:100px;" onclick="window.open('https://amazon.in')">üéí Gear</button>
            </div>
        </div>

        <h6 class="fw-bold ms-2 mb-2">MY TRIPS</h6>
        <div id="userTripList"><p class="text-center small">Loading...</p></div>
        
        <br>
        <button class="neu-btn neu-btn-danger mb-4" onclick="donateUPI()">‚ù§Ô∏è Support Dev</button>
    </div>
</div>

<div id="mainApp" style="display:none;">
    <div class="app-header">
        <i class="bi bi-chevron-left fs-3" onclick="showHome()" style="cursor:pointer;"></i>
        <div class="text-center">
            <span class="fw-bold fs-5" id="dispName">Trip</span><br>
            <small style="font-size:0.7rem; color:var(--primary);" id="dispCode"></small>
        </div>
        <div></div>
    </div>

    <div class="container">
        <div class="row g-3 mb-4">
            <div class="col-6">
                <div class="neu-card text-center py-3 mb-0">
                    <small>BALANCE</small><br>
                    <span class="stat-text text-success">‚Çπ<span id="cashHand">0</span></span>
                </div>
            </div>
            <div class="col-6">
                <div class="neu-card text-center py-3 mb-0">
                    <small>PER HEAD</small><br>
                    <span class="stat-text text-primary">‚Çπ<span id="perPersonDisplay">0</span></span>
                </div>
            </div>
        </div>

        <div id="headActionArea" class="mb-4"></div>

        <div class="d-flex justify-content-between gap-2 mb-3">
            <button class="neu-btn neu-btn-danger" onclick="toggleForm('formExp')"><i class="bi bi-dash-circle"></i> Exp</button>
            <button class="neu-btn neu-btn-success" onclick="toggleForm('formDep')"><i class="bi bi-plus-circle"></i> Dep</button>
            <button class="neu-btn" onclick="toggleForm('formMem')"><i class="bi bi-camera"></i> Post</button>
        </div>

        <div id="formExp" class="neu-card toggle-form">
            <h6 class="text-danger">Add Expense</h6>
            <input type="text" id="expRea" class="neu-input" placeholder="Item Name">
            <input type="number" id="expAmt" class="neu-input" placeholder="‚Çπ Amount">
            <button class="neu-btn neu-btn-danger" onclick="addExp()">Save</button>
        </div>
        <div id="formDep" class="neu-card toggle-form">
            <h6 class="text-success">Cash Deposit</h6>
            <select id="depMem" class="neu-input"></select>
            <input type="number" id="depAmt" class="neu-input" placeholder="‚Çπ Amount">
            <button class="neu-btn neu-btn-success" onclick="addDep()">Save</button>
        </div>
        <div id="formMem" class="neu-card toggle-form">
            <h6 class="text-warning">Post Memory</h6>
            <input type="text" id="highTxt" class="neu-input" placeholder="Caption...">
            <input type="file" id="highImg" class="neu-input" accept="image/*" multiple onchange="encodeImgs(this)">
            <button class="neu-btn" onclick="saveMem('trip')">Post</button>
        </div>

        <div class="neu-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="fw-bold m-0 text-primary">üöå Transport</h6>
                <select id="transType" class="neu-input py-1 px-2 w-auto mb-0" style="font-size:0.8rem;" onchange="toggleTransportMode()">
                    <option value="fuel">Fuel</option><option value="public">Public</option>
                </select>
            </div>
            
            <div id="fuelInputs">
                <div class="d-flex gap-2 mb-2">
                    <input type="number" id="fDist" class="neu-input mb-0" placeholder="KM">
                    <input type="number" id="fMil" class="neu-input mb-0" placeholder="Avg">
                </div>
                <input type="number" id="fRate" class="neu-input" placeholder="Price">
                <button class="neu-btn neu-btn-primary" onclick="addFuel()">Add Fuel Cost</button>
            </div>
            <div id="publicInputs" style="display:none;">
                <div class="d-flex gap-2 mb-2">
                    <input type="text" id="ptFrom" class="neu-input mb-0" placeholder="From">
                    <input type="text" id="ptTo" class="neu-input mb-0" placeholder="To">
                </div>
                <div class="d-flex gap-2 mb-2">
                    <select id="ptMode" class="neu-input mb-0"><option>Bus</option><option>Train</option></select>
                    <input type="number" id="ptFare" class="neu-input mb-0" placeholder="‚Çπ">
                </div>
                <button class="neu-btn neu-btn-primary" onclick="addPublicTransport()">Add Ticket</button>
            </div>
            <button class="neu-btn neu-btn-success mt-3" onclick="shareFullRoute()"><i class="bi bi-whatsapp"></i> Share Plan</button>
        </div>

        <div class="neu-card p-3">
            <h6 class="text-muted small fw-bold mb-3">RECENT ACTIVITY</h6>
            <div id="expList" style="max-height:300px; overflow-y:auto;"></div>
        </div>

        <div class="neu-card">
            <div class="d-flex justify-content-between mb-2"><h6 class="fw-bold m-0">Members</h6><small class="text-primary" style="cursor:pointer;" onclick="setHead()">Set Head</small></div>
            <div id="memList" class="d-flex flex-wrap gap-2"></div>
        </div>

        <h6 class="text-muted fw-bold small mt-4 ps-2">MEMORIES</h6>
        <div id="tripFeedArea"></div>
        
        <div class="neu-card mt-3"><h6 class="text-primary mb-3">Final Settlement</h6><div id="finalList" class="small"></div></div>
    </div>
</div>

<div id="settingsScreen" style="display:none;">
    <div class="app-header"><i class="bi bi-chevron-left fs-3" onclick="showHome()"></i> Settings <div></div></div>
    <div class="container text-center">
        <div class="neu-card">
            <h4 id="s_name" class="mb-3">--</h4>
            <input type="text" id="up_name" class="neu-input" placeholder="Name">
            <input type="text" id="up_address" class="neu-input" placeholder="Address">
            <input type="text" id="up_pass" class="neu-input" placeholder="New Password">
            <button class="neu-btn neu-btn-primary" onclick="saveSettings()">Update Profile</button>
        </div>
        <button class="neu-btn mb-3" onclick="document.getElementById('aboutModal').style.display='flex'">‚ÑπÔ∏è About App</button>
        <button class="neu-btn neu-btn-danger" onclick="doLogout()">Log Out</button>
    </div>
</div>

<script>
// --- CONFIG ---
const DEV_NAME = "YOUR NAME"; 
const DEV_UPI_ID = "YOUR_UPI"; 

const firebaseConfig = {
      apiKey: "AIzaSyCp_ctBvgHAmqxpU9xDbxaufDftKulcJXk",
      authDomain: "akproject-176c7.firebaseapp.com",
      databaseURL: "https://akproject-176c7-default-rtdb.firebaseio.com",
      projectId: "akproject-176c7",
      storageBucket: "akproject-176c7.firebasestorage.app",
      messagingSenderId: "769234833598",
      appId: "1:769234833598:web:db90a08802c07d94810eef"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let user=null, tid="", tripData={}, tempImages=[], headPayAmt=0;
function safeArray(d){ return d ? (Array.isArray(d)?d:Object.values(d)) : []; }
function closeModal(id){ document.getElementById(id).style.display='none'; }

// AUTH
window.onload = () => { 
    document.querySelectorAll('#devNameAbout').forEach(e=>e.innerText=DEV_NAME); 
    const s=localStorage.getItem('yatra_user'); 
    if(s){ user=JSON.parse(s); document.getElementById('headerUserName').innerText=user.name; showHome(); } 
    else { document.getElementById('authScreen').style.display='flex'; } 
};

function hideAll() { ['authScreen','homeScreen','mainApp','settingsScreen'].forEach(i => document.getElementById(i).style.display='none'); }
function showLogin() { hideAll(); document.getElementById('authScreen').style.display='flex'; document.getElementById('loginForm').style.display='block'; document.getElementById('regForm').style.display='none'; }
function showReg() { document.getElementById('loginForm').style.display='none'; document.getElementById('regForm').style.display='block'; }
function showHome() { hideAll(); document.getElementById('homeScreen').style.display='block'; loadTrips(); }
function openSettings() { hideAll(); document.getElementById('settingsScreen').style.display='block'; db.ref('users/'+user.mobile).once('value',s=>{const u=s.val();document.getElementById('s_name').innerText=u.name;document.getElementById('up_name').value=u.name;document.getElementById('up_address').value=u.address||"";document.getElementById('up_pass').value=u.password;}); }
function toggleForm(id) { const el = document.getElementById(id); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }

// LOGIC
function doRegister(){const n=document.getElementById('r_name').value,m=document.getElementById('r_mobile').value,a=document.getElementById('r_address').value,p=document.getElementById('r_pass').value; if(n&&m&&a&&p) db.ref('users/'+m).set({name:n,mobile:m,address:a,password:p,history:[]}).then(()=>{alert("Created!");showLogin();});}
function doLogin(){const m=document.getElementById('l_mobile').value,p=document.getElementById('l_pass').value; if(!m||!p)return; db.ref('users/'+m).once('value',s=>{if(s.exists()&&s.val().password==p){user=s.val();localStorage.setItem('yatra_user',JSON.stringify(user));document.getElementById('headerUserName').innerText=user.name;showHome();}else alert("Invalid");});}
function doLogout(){localStorage.removeItem('yatra_user');location.reload();}
function saveSettings(){const n=document.getElementById('up_name').value,a=document.getElementById('up_address').value,p=document.getElementById('up_pass').value; if(n) db.ref('users/'+user.mobile).update({name:n,address:a,password:p}).then(()=>{user.name=n;localStorage.setItem('yatra_user',JSON.stringify(user));alert("Saved!");showHome();});}

function createTrip(){const n=prompt("Trip Name:");if(n){const id="T"+Math.floor(10000+Math.random()*90000);db.ref('trips/'+id).set({name:n,members:[user.name]}).then(()=>{addHistory(id);enterTrip(id);});}}
function joinTrip(){const id=prompt("Code:");if(id)db.ref('trips/'+id.toUpperCase()).once('value',s=>{if(s.exists()){addHistory(id.toUpperCase());enterTrip(id.toUpperCase());}else alert("Invalid");});}
function addHistory(id){db.ref('users/'+user.mobile+'/history').once('value',s=>{let h=safeArray(s.val());if(!h.includes(id)){h.push(id);db.ref('users/'+user.mobile+'/history').set(h);}});}
function deleteTrip(id,e){e.stopPropagation();if(confirm("Delete?"))db.ref('users/'+user.mobile+'/history').once('value',s=>{db.ref('users/'+user.mobile+'/history').set(safeArray(s.val()).filter(x=>x!==id));});}
function loadTrips(){db.ref('users/'+user.mobile+'/history').on('value',async s=>{const l=document.getElementById('userTripList');l.innerHTML="";const c=safeArray(s.val());if(c.length===0){l.innerHTML="<p class='small text-muted'>No trips.</p>";return;}for(const i of c){const sp=await db.ref('trips/'+i).once('value');if(sp.exists()){l.innerHTML+=`<div class="neu-card d-flex justify-content-between align-items-center p-3 mb-3" style="cursor:pointer;" onclick="enterTrip('${i}')"><div><b>${sp.val().name}</b><br><small class="text-muted">${i}</small></div><i class="bi bi-trash text-danger" onclick="deleteTrip('${i}',event)"></i></div>`;}}});}

function enterTrip(id){tid=id;hideAll();document.getElementById('mainApp').style.display='block';db.ref('trips/'+tid).on('value',s=>{tripData=s.val();if(!tripData)return;let m=safeArray(tripData.members);if(!m.includes(user.name)){m.push(user.name);db.ref('trips/'+tid+'/members').set(m);}tripData.members=m;renderUI();renderTripFeed();});}

function renderUI(){
    document.getElementById('dispName').innerText=tripData.name; document.getElementById('dispCode').innerText=tid;
    const isHead=(user.name.toLowerCase()===(tripData.head||"").toLowerCase());
    const hDiv=document.getElementById('headActionArea'); hDiv.innerHTML="";
    if(isHead) hDiv.innerHTML=`<button class="neu-btn neu-btn-primary mb-3" onclick="document.getElementById('headSetupModal').style.display='flex'">üè¶ Setup UPI</button>`;
    else if(tripData.head) hDiv.innerHTML=`<button class="neu-btn neu-btn-success mb-3" onclick="payHead()">üí∏ Pay Head</button>`;

    const l=document.getElementById('expList'); l.innerHTML="";
    
    // Deposits
    safeArray(tripData.deposits).slice().reverse().forEach(d=>{
        const canDel = (d.who === user.name || isHead);
        const delBtn = canDel ? `<i class="bi bi-trash text-danger ms-2" onclick="delDep(${d.t})" style="cursor:pointer;"></i>` : "";
        l.innerHTML+=`<div class="list-item list-item-green"><div><small class="text-muted">${new Date(d.t).toLocaleDateString()}</small><br><b>${d.who}</b></div><div><b class="text-success">+‚Çπ${d.amt}</b> ${delBtn}</div></div>`;
    });

    // Expenses
    safeArray(tripData.expenses).slice().reverse().forEach(e=>{
        const isR=e.r.includes("‚ûî"); const share=isR?`<i class="bi bi-whatsapp text-success ms-2" onclick="shareR('${e.r}',${e.a})"></i>`:"";
        const del=isHead?`<i class="bi bi-trash text-danger ms-2" onclick="delExp(${e.t})" style="cursor:pointer;"></i>`:"";
        l.innerHTML+=`<div class="list-item list-item-red"><div><small class="text-muted">${new Date(e.t).toLocaleDateString()}</small><br><span>${e.r}</span></div><div class="text-end"><b class="text-danger">-‚Çπ${e.a}</b><br>${share}${del}</div></div>`;
    });

    const mDiv=document.getElementById('memList'); mDiv.innerHTML=""; const sel=document.getElementById('depMem'); sel.innerHTML="";
    tripData.members.forEach(m=>{
        const isH=(tripData.head&&m.toLowerCase()===tripData.head.toLowerCase());
        mDiv.innerHTML+=`<span class="badge ${isH?'bg-warning text-dark border border-warning':'bg-light text-dark'} p-2 me-1">${isH?'üëë':''} ${m}</span>`;
        sel.innerHTML+=`<option value="${m}">${m}</option>`;
    });

    const tin=safeArray(tripData.deposits).reduce((s,x)=>s+x.amt,0), tout=safeArray(tripData.expenses).reduce((s,x)=>s+x.a,0);
    document.getElementById('cashHand').innerText=tin-tout; 
    document.getElementById('perPersonDisplay').innerText=tripData.members.length?Math.round(tout/tripData.members.length):0;
    
    const fDiv=document.getElementById('finalList'); fDiv.innerHTML=""; let ph=Math.round(tout/tripData.members.length), pd={};
    tripData.members.forEach(m=>pd[m]=0); safeArray(tripData.deposits).forEach(d=>{if(pd[d.who]!==undefined)pd[d.who]+=d.amt;});
    tripData.members.forEach(m=>{let b=ph-pd[m]; fDiv.innerHTML+=`<div class="d-flex justify-content-between border-bottom py-1"><span>${m}</span><span>${b>0?'Pay: '+b:'Get: '+Math.abs(b)}</span></div>`;});
}

function addExp(){const r=document.getElementById('expRea').value,a=parseFloat(document.getElementById('expAmt').value);if(r&&a){db.ref('trips/'+tid+'/expenses').set([...safeArray(tripData.expenses),{r,a,t:Date.now()}]);toggleForm('formExp');}}
function addDep(){const w=document.getElementById('depMem').value,a=parseFloat(document.getElementById('depAmt').value);if(w&&a){db.ref('trips/'+tid+'/deposits').set([...safeArray(tripData.deposits),{who:w,amt:a,t:Date.now()}]);toggleForm('formDep');}}
function delExp(t){if(confirm("Delete Expense?"))db.ref('trips/'+tid+'/expenses').set(safeArray(tripData.expenses).filter(x=>x.t!==t));}
function delDep(t){if(confirm("Delete this Deposit?"))db.ref('trips/'+tid+'/deposits').set(safeArray(tripData.deposits).filter(x=>x.t!==t));}

function setHead(){const h=prompt("Head Name:");if(h)db.ref('trips/'+tid+'/head').set(h);}
function saveHeadUPI(){const u=document.getElementById('headUPIInput').value;if(u){db.ref('trips/'+tid+'/headUPI').set(u);closeModal('headSetupModal');}}
function payHead(){const a=prompt("Amount:");if(a){if(!tripData.headUPI){alert("No UPI Set");return;} headPayAmt=parseFloat(a); const l=`upi://pay?pa=${tripData.headUPI}&pn=${tripData.head}&am=${a}&cu=INR`; document.getElementById('payHeadModal').style.display='flex'; document.getElementById('headNameDisplay').innerText="To: "+tripData.head; document.getElementById('headPayAmt').innerText=a; document.getElementById('headPayLink').href=l; document.getElementById('headQrImage').innerHTML=`<img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(l)}">`; }}
function confirmHeadPayment(){db.ref('trips/'+tid+'/deposits').set([...safeArray(tripData.deposits),{who:user.name,amt:headPayAmt,t:Date.now()}]);closeModal('payHeadModal');alert("Added!");}
function donateUPI(){const a=prompt("Amount:");if(a){const l=`upi://pay?pa=${DEV_UPI_ID}&pn=${DEV_NAME}&am=${a}&cu=INR`; document.getElementById('qrModal').style.display='flex'; document.getElementById('qrAmount').innerText=a; document.getElementById('payLink').href=l; document.getElementById('qrImage').innerHTML=`<img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(l)}">`;}}

function toggleTransportMode(){const m=document.getElementById('transType').value;document.getElementById('fuelInputs').style.display=(m==='fuel'?'block':'none');document.getElementById('publicInputs').style.display=(m==='public'?'block':'none');}
function addFuel(){const d=document.getElementById('fDist').value,m=document.getElementById('fMil').value,r=document.getElementById('fRate').value;if(d&&m&&r)db.ref('trips/'+tid+'/expenses').set([...safeArray(tripData.expenses),{r:`‚õΩ Fuel ${d}km`,a:Math.round((d/m)*r),t:Date.now()}]);}
function addPublicTransport(){const f=document.getElementById('ptFrom').value,t=document.getElementById('ptTo').value,m=document.getElementById('ptMode').value,a=parseFloat(document.getElementById('ptFare').value);if(f&&t&&a){db.ref('trips/'+tid+'/expenses').set([...safeArray(tripData.expenses),{r:`${m}: ${f} ‚ûî ${t}`,a,t:Date.now()}]);alert("Added!");}}
function shareR(r,a){window.open(`https://wa.me/?text=${encodeURIComponent(`üöå Route: ${r}\nüí∞ Fare: ‚Çπ${a}\nvia GHUMO PRO`)}`,'_blank');}
function shareFullRoute(){const r=safeArray(tripData.expenses).filter(e=>e.r.includes("‚ûî"));if(!r.length)return alert("No routes");let m=`üöÄ *TRIP PLAN: ${tripData.name}*\n\n`,t=0;r.forEach((x,i)=>{m+=`‚úÖ Step ${i+1}: ${x.r} (‚Çπ${x.a})\n`;t+=x.a;});m+=`\nüí∞ Total Transport: ‚Çπ${t}`;window.open(`https://wa.me/?text=${encodeURIComponent(m)}`,'_blank');}

function renderTripFeed(){const d=document.getElementById('tripFeedArea');d.innerHTML="";safeArray(tripData.highlights).reverse().forEach(h=>{let im="";if(h.imgs)h.imgs.forEach(i=>im+=`<img src="${i}" style="width:100%; border-radius:10px; margin-top:5px;">`);d.innerHTML+=`<div class="neu-card p-3 mb-3"><b>${h.who}</b><br>${h.txt}<div>${im}</div></div>`;});}
function encodeImgs(i){tempImages=[];if(i.files)Array.from(i.files).forEach(f=>{const r=new FileReader();r.onload=e=>{const img=new Image();img.src=e.target.result;img.onload=()=>{const c=document.createElement('canvas'),ctx=c.getContext('2d');const w=500,sc=w/img.width;c.width=w;c.height=img.height*sc;ctx.drawImage(img,0,0,c.width,c.height);tempImages.push(c.toDataURL('image/jpeg',0.6));}};r.readAsDataURL(f);});}
function saveMem(t){const x=document.getElementById('highTxt').value;if(!x)return;db.ref('trips/'+tid+'/highlights').set([...safeArray(tripData.highlights),{who:user.name,txt:x,imgs:tempImages,t:Date.now()}]);alert("Posted!");toggleForm('formMem');}
</script>
</body>
</html>
